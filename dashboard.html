<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scouting Stats</title>
  <style>
    :root {
      --blue: #003F87;
      --blue-dark: #002A5C;
      --blue-light: #1a5fb4;
      --gold: #FDB927;
      --gold-dark: #92400e;
      --red: #BF0000;
      --green: #00843D;
      --green-light: #065f46;
      --bg: #f0f4f8;
      --card: #ffffff;
      --border: #e5e7eb;
      --muted: #6b7280;
      --shadow: 0 2px 10px rgba(0,0,0,0.08);
      --radius: 12px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, 'Segoe UI', sans-serif;
      background: var(--bg);
      color: #111827;
      min-height: 100vh;
      font-size: 14px;
      overflow-x: hidden;
    }

    /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
    header {
      background: var(--blue);
      color: white;
      padding: 0 20px;
      height: 56px;
      display: flex;
      align-items: center;
      gap: 16px;
      position: sticky;
      top: 0;
      z-index: 200;
      box-shadow: 0 2px 12px rgba(0,0,0,0.35);
    }
    .logo { font-size: 1.1rem; font-weight: 700; display: flex; align-items: center; gap: 8px; white-space: nowrap; flex: 1 1 auto; min-width: 0; overflow: hidden; }
    .logo-icon { font-size: 1.4rem; line-height: 1; flex-shrink: 0; }
    #header-title { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    nav.main-tabs { display: flex; gap: 4px; margin-left: auto; flex-shrink: 0; }
    .tab-btn {
      background: transparent;
      border: none;
      color: rgba(255,255,255,0.65);
      padding: 7px 18px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.875rem;
      font-weight: 600;
      transition: all 0.15s;
      letter-spacing: 0.02em;
    }
    .tab-btn:hover { background: rgba(255,255,255,0.12); color: white; }
    .tab-btn.active { background: var(--gold); color: var(--blue-dark); }

    /* ‚îÄ‚îÄ DB View ‚îÄ‚îÄ */
    .db-view-content {
      display: flex;
      flex-direction: row;
      align-items: flex-start;
      justify-content: center;
      gap: 20px;
      padding: 40px 20px;
    }
    .db-info-card { text-align: left; padding: 28px 36px; }
    .db-info-card h2 { margin-bottom: 16px; }
    .db-info-troop { margin-bottom: 16px; }
    .db-info-troop .label { font-size: 0.75rem; color: var(--muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em; margin-bottom: 2px; }
    .db-info-troop .value { font-size: 1.05rem; font-weight: 700; }
    .db-stats-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
    .db-stats-table th { text-align: left; padding: 5px 0; border-bottom: 1px solid var(--border); font-size: 0.72rem; color: var(--muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em; }
    .db-stats-table th:last-child { text-align: right; }
    .db-stats-table td { padding: 5px 0; border-bottom: 1px solid var(--border); color: #374151; }
    .db-stats-table tr:last-child td { border-bottom: none; }
    .db-stats-table td:last-child { text-align: right; font-variant-numeric: tabular-nums; font-weight: 600; color: var(--blue); }
    .db-card {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 40px 48px;
      text-align: center;
      max-width: 440px;
      width: 100%;
    }
    .db-card-icon { font-size: 2.5rem; margin-bottom: 12px; }
    .db-card h2 { font-size: 1.2rem; font-weight: 700; margin-bottom: 8px; }
    .db-card p { color: var(--muted); margin-bottom: 24px; font-size: 0.88rem; line-height: 1.5; }
    #db-status { margin-top: 16px; font-size: 0.85rem; color: var(--muted); min-height: 1.2em; }
    .file-label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: var(--gold);
      color: var(--blue-dark);
      padding: 7px 14px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 700;
      font-size: 0.8rem;
      white-space: nowrap;
      flex-shrink: 0;
    }
    .file-label:hover { filter: brightness(1.05); }
    #db-file { display: none; }

    /* ‚îÄ‚îÄ Views ‚îÄ‚îÄ */
    .view { display: none; }
    .view.active { display: block; }

    /* ‚îÄ‚îÄ Scout Layout ‚îÄ‚îÄ */
    .scout-layout { display: flex; min-height: calc(100vh - 56px); }
    .scout-sidebar {
      width: 220px;
      flex-shrink: 0;
      background: var(--card);
      border-right: 1px solid var(--border);
      padding: 18px 14px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      position: sticky;
      top: 56px;
      height: calc(100vh - 56px);
      overflow: hidden;
    }
    .sidebar-label {
      font-size: 0.68rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--muted);
      font-weight: 700;
    }
    .scout-main { flex: 1; padding: 20px; overflow-x: hidden; min-width: 0; }

    select {
      width: 100%;
      padding: 9px 10px;
      border: 1.5px solid var(--border);
      border-radius: 8px;
      font-size: 0.875rem;
      background: white;
      cursor: pointer;
      color: #111827;
      appearance: auto;
    }
    select:focus { outline: none; border-color: var(--blue); }

    .scout-picker { display: flex; flex-direction: column; gap: 6px; flex: 1; overflow: hidden; min-height: 0; }
    .scout-filter-input {
      width: 100%; padding: 7px 10px; border: 1.5px solid var(--border);
      border-radius: 8px; font-size: 0.82rem; background: white; color: #111827;
      box-sizing: border-box; outline: none; flex-shrink: 0;
    }
    .scout-filter-input:focus { border-color: var(--blue); }
    .scout-filter-input:disabled { color: var(--muted); background: var(--bg); }
    .scout-list {
      flex: 1; min-height: 0; overflow-y: auto; border: 1.5px solid var(--border);
      border-radius: 8px; background: white;
    }
    .scout-list-item {
      padding: 8px 10px; font-size: 0.82rem; cursor: pointer;
      border-bottom: 1px solid #f3f4f6; white-space: nowrap;
      overflow: hidden; text-overflow: ellipsis; transition: background 0.1s;
    }
    .scout-list-item:last-child { border-bottom: none; }
    .scout-list-item:hover { background: var(--bg); }
    .scout-list-item.active { background: #dbeafe; color: var(--blue); font-weight: 600; }

    .scout-meta-card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 14px 18px;
      box-shadow: var(--shadow);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 18px;
      flex-wrap: wrap;
    }
    .scout-meta-card .rank-badge {
      display: inline-block;
      background: var(--blue);
      color: white;
      padding: 4px 14px;
      border-radius: 99px;
      font-size: 0.82rem;
      font-weight: 700;
      white-space: nowrap;
      flex-shrink: 0;
    }
    .scout-meta-items {
      display: flex; gap: 18px; flex-wrap: wrap; align-items: center;
      font-size: 0.82rem; color: var(--muted);
    }
    .scout-meta-item { display: flex; gap: 4px; align-items: baseline; white-space: nowrap; }
    .scout-meta-label { font-weight: 600; color: #374151; }

    /* ‚îÄ‚îÄ Stat Cards ‚îÄ‚îÄ */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(165px, 1fr));
      gap: 14px;
      margin-bottom: 20px;
    }
    .stat-card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 18px;
      box-shadow: var(--shadow);
      border-left: 4px solid var(--blue);
    }
    .stat-card.gold  { border-color: var(--gold); }
    .stat-card.green { border-color: var(--green); }
    .stat-card.red   { border-color: var(--red); }
    .stat-card.purple { border-color: #7c3aed; }

    .stat-label { font-size: 0.68rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--muted); font-weight: 700; margin-bottom: 6px; }
    .stat-value { font-size: 2rem; font-weight: 800; color: var(--blue); line-height: 1; }
    .stat-card.gold  .stat-value { color: var(--gold-dark); }
    .stat-card.green .stat-value { color: var(--green); }
    .stat-card.red   .stat-value { color: var(--red); }
    .stat-card.purple .stat-value { color: #5b21b6; }
    .stat-sub { font-size: 0.76rem; color: var(--muted); margin-top: 5px; }

    /* ‚îÄ‚îÄ Progress Bars ‚îÄ‚îÄ */
    .prog-bar { background: var(--border); border-radius: 99px; height: 7px; margin-top: 9px; overflow: hidden; }
    .prog-fill { height: 100%; border-radius: 99px; transition: width 0.6s ease; background: var(--blue); }
    .prog-fill.gold   { background: var(--gold); }
    .prog-fill.green  { background: var(--green); }
    .prog-fill.red    { background: var(--red); }
    .prog-fill.purple { background: #7c3aed; }

    /* ‚îÄ‚îÄ Panels ‚îÄ‚îÄ */
    .panels-grid { display: flex; flex-direction: column; gap: 18px; }
    .panels-pair { display: flex; gap: 18px; align-items: flex-start; }
    .panels-col  { flex: 1; display: flex; flex-direction: column; gap: 18px; min-width: 0; }

    .panel {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    .panel-header {
      padding: 14px 18px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 8px;
      background: #fafafa;
    }
    .panel-header h2 { font-size: 0.9rem; font-weight: 700; margin: 0; }
    .panel-icon { font-size: 1rem; line-height: 1; }
    .panel-body { padding: 16px 18px; }
    .panel-body.no-pad { padding: 0; }

    /* ‚îÄ‚îÄ Tables ‚îÄ‚îÄ */
    .tbl-wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
    th {
      text-align: left;
      padding: 7px 12px;
      font-size: 0.67rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      border-bottom: 2px solid var(--border);
      white-space: nowrap;
      background: #fafafa;
    }
    td { padding: 9px 12px; border-bottom: 1px solid var(--border); vertical-align: middle; }
    tr:last-child td { border-bottom: none; }
    tbody tr:hover td { background: #f9fafb; }
    .bold-row td { font-weight: 700; }

    /* ‚îÄ‚îÄ Badges / Pills ‚îÄ‚îÄ */
    .pill {
      display: inline-flex;
      align-items: center;
      padding: 2px 9px;
      border-radius: 99px;
      font-size: 0.7rem;
      font-weight: 700;
      white-space: nowrap;
    }
    .pill-blue   { background: #dbeafe; color: #1e40af; }
    .pill-green  { background: #d1fae5; color: var(--green-light); }
    .pill-gold   { background: #fef3c7; color: var(--gold-dark); }
    .pill-red    { background: #fee2e2; color: #991b1b; }
    .pill-gray   { background: #f3f4f6; color: #4b5563; }
    .pill-purple { background: #ede9fe; color: #5b21b6; }

    /* ‚îÄ‚îÄ Eagle MB Grid ‚îÄ‚îÄ */
    .eagle-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 7px;
    }
    .eagle-item {
      padding: 7px 10px;
      border-radius: 8px;
      font-size: 0.77rem;
      display: flex;
      align-items: center;
      gap: 6px;
      border: 1.5px solid var(--border);
      line-height: 1.3;
    }
    .eagle-item.earned    { background: #d1fae5; border-color: #6ee7b7; color: var(--green-light); }
    .eagle-item.progress  { background: #fef3c7; border-color: #fcd34d; color: var(--gold-dark); }
    .eagle-item.needed    { background: #fff7ed; border-color: #fdba74; color: #9a3412; }
    .ei-icon { font-size: 0.95rem; flex-shrink: 0; }

    /* ‚îÄ‚îÄ Eagle Choice Groups ‚îÄ‚îÄ */
    .choice-section-label {
      font-size: 0.68rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--muted);
      font-weight: 700;
      margin: 14px 0 8px;
    }
    .choice-group {
      border: 1.5px solid var(--border);
      border-radius: 10px;
      margin-bottom: 8px;
      overflow: hidden;
    }
    .choice-group.cg-satisfied { border-color: #6ee7b7; }
    .choice-group.cg-progress  { border-color: #fcd34d; }
    .choice-group-header {
      padding: 8px 12px;
      background: #f9fafb;
      font-size: 0.78rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .choice-group.cg-satisfied .choice-group-header { background: #ecfdf5; }
    .choice-group.cg-progress  .choice-group-header { background: #fffbeb; }
    .choice-group-options {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      padding: 10px 12px;
      background: white;
    }
    /* Troop-level choice group rows */
    .cg-troop-row {
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
    }
    .cg-troop-row:last-child { border-bottom: none; }
    .cg-troop-badges { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 6px; }
    .cg-badge-stat {
      display: flex;
      flex-direction: column;
      align-items: center;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 6px 12px;
      font-size: 0.75rem;
      min-width: 100px;
    }
    .cg-badge-name { font-weight: 600; color: #374151; }
    .cg-badge-count { font-size: 1rem; font-weight: 800; color: var(--blue); }
    .cg-badge-sub { font-size: 0.68rem; color: var(--muted); }

    /* ‚îÄ‚îÄ Requirement List ‚îÄ‚îÄ */
    .req-list { list-style: none; }
    .req-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
      font-size: 0.82rem;
    }
    .req-item:last-child { border-bottom: none; }
    .req-circle {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.72rem;
      flex-shrink: 0;
      margin-top: 1px;
    }
    .req-circle.done { background: #d1fae5; color: var(--green-light); font-weight: 700; }
    .req-circle.todo { background: #f3f4f6; color: #9ca3af; border: 2px dashed #d1d5db; }
    .req-num { font-size: 0.68rem; color: var(--muted); font-weight: 700; }
    .req-date { font-size: 0.7rem; color: var(--green); margin-top: 2px; }

    /* ‚îÄ‚îÄ Rank Pipeline ‚îÄ‚îÄ */
    .pipeline-wrap { overflow-x: auto; padding-bottom: 4px; }
    .pipeline {
      display: inline-flex;
      align-items: flex-start;
      gap: 0;
      padding: 8px 4px;
      min-width: 100%;
    }
    .pipe-step { display: flex; flex-direction: column; align-items: center; min-width: 82px; position: relative; }
    .pipe-step:not(:last-child)::after {
      content: '';
      position: absolute;
      left: 50%;
      top: 20px;
      width: calc(100% - 4px);
      height: 3px;
      background: var(--border);
      z-index: 0;
    }
    .pipe-step.done::after { background: var(--green); }
    .pipe-dot {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--border);
      border: 3px solid white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.72rem;
      font-weight: 800;
      color: #6b7280;
      position: relative;
      z-index: 1;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    .pipe-dot.done    { background: var(--green); color: white; }
    .pipe-dot.current { background: var(--blue); color: white; }
    .pipe-dot.next    { background: var(--gold); color: var(--blue-dark); border-color: var(--gold); }
    .pipe-label { font-size: 0.62rem; text-align: center; margin-top: 6px; color: var(--muted); max-width: 76px; line-height: 1.3; }
    .pipe-label.current { color: var(--blue); font-weight: 700; }
    .pipe-label.done    { color: var(--green); }

    /* ‚îÄ‚îÄ Mini Bar (inline) ‚îÄ‚îÄ */
    .bar-cell { min-width: 110px; }
    .bar-wrap { display: flex; align-items: center; gap: 6px; }
    .mini-bar { flex: 1; background: var(--border); border-radius: 4px; height: 6px; overflow: hidden; min-width: 40px; }
    .mini-fill { height: 100%; border-radius: 4px; background: var(--blue); }
    .mini-fill.gold   { background: var(--gold); }
    .mini-fill.green  { background: var(--green); }
    .mini-fill.red    { background: var(--red); }
    .mini-fill.purple { background: #7c3aed; }
    .bar-pct { font-size: 0.72rem; color: var(--muted); white-space: nowrap; min-width: 34px; text-align: right; }

    /* ‚îÄ‚îÄ Mini Tabs ‚îÄ‚îÄ */
    .mini-tabs { display: flex; gap: 4px; margin-bottom: 12px; flex-wrap: wrap; }
    .mini-tab {
      padding: 5px 12px;
      border-radius: 6px;
      font-size: 0.77rem;
      font-weight: 600;
      cursor: pointer;
      border: 1.5px solid var(--border);
      background: white;
      color: var(--muted);
    }
    .mini-tab:hover { border-color: var(--blue); color: var(--blue); }
    .mini-tab.active { background: var(--blue); color: white; border-color: var(--blue); }

    /* ‚îÄ‚îÄ Empty / No-data ‚îÄ‚îÄ */
    .empty-state { text-align: center; padding: 60px 20px; color: var(--muted); }
    .empty-state .ei { font-size: 3rem; margin-bottom: 12px; }
    .empty-state p { font-size: 0.875rem; line-height: 1.6; max-width: 320px; margin: 0 auto; }
    .no-data { text-align: center; padding: 28px; color: var(--muted); font-size: 0.82rem; }

    /* ‚îÄ‚îÄ Eagle star marker ‚îÄ‚îÄ */
    .star-marker { color: var(--gold); font-size: 0.8rem; }

    /* ‚îÄ‚îÄ Troop view ‚îÄ‚îÄ */
    .troop-main { padding: 20px; }

    /* ‚îÄ‚îÄ Alerts / callouts ‚îÄ‚îÄ */
    .callout {
      background: #fefce8;
      border: 1px solid #fde047;
      border-radius: 8px;
      padding: 10px 14px;
      font-size: 0.8rem;
      color: #713f12;
      margin-bottom: 12px;
    }

    /* ‚îÄ‚îÄ MB Detail Modal ‚îÄ‚îÄ */
    .mb-modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.48);
      z-index: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.18s;
    }
    .mb-modal-overlay.open { opacity: 1; pointer-events: all; }
    .mb-modal {
      background: white;
      border-radius: var(--radius);
      box-shadow: 0 24px 64px rgba(0,0,0,0.28);
      width: 100%;
      max-width: 700px;
      max-height: 88vh;
      display: flex;
      flex-direction: column;
      transform: scale(0.96) translateY(8px);
      transition: transform 0.18s;
    }
    .mb-modal-overlay.open .mb-modal { transform: scale(1) translateY(0); }
    .mb-modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      flex-shrink: 0;
    }
    .mb-modal-close {
      background: #f3f4f6;
      border: none;
      border-radius: 6px;
      width: 28px;
      height: 28px;
      cursor: pointer;
      font-size: 0.85rem;
      color: var(--muted);
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .mb-modal-close:hover { background: var(--border); color: #111; }
    .mb-modal-body { overflow-y: auto; padding: 14px 18px; flex: 1; }

    /* Requirement tree nodes */
    .req-node {
      border-radius: 8px;
      margin-bottom: 5px;
      overflow: hidden;
      border: 1px solid var(--border);
    }
    .req-node.node-done { border-color: #bbf7d0; background: #f0fdf4; }
    .req-node.node-todo { background: #fafafa; }
    .req-node.is-note   { background: transparent; border-color: transparent; }
    .req-node.is-child  { border-radius: 6px; margin-bottom: 3px; }
    .req-node-row {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 9px 12px;
    }
    .req-node-text { flex: 1; min-width: 0; font-size: 0.83rem; line-height: 1.5; }
    .req-node-title { display: flex; gap: 5px; align-items: baseline; flex-wrap: wrap; }
    .req-children { padding: 0 10px 8px 44px; }
    .req-choose-label {
      font-size: 0.71rem;
      color: var(--muted);
      font-style: italic;
      padding: 2px 10px 6px 44px;
    }
    .req-note-text {
      font-size: 0.78rem;
      color: var(--muted);
      font-style: italic;
      padding: 5px 12px 5px 20px;
      border-left: 3px solid var(--border);
      margin: 2px 0 6px;
      line-height: 1.5;
    }

    /* Clickable rows */
    .clickable-row { cursor: pointer; }
    .clickable-row:hover td { background: #f0f4f8 !important; }
    .mb-name-link { color: var(--blue); text-decoration: underline; text-decoration-style: dotted; }
    .scout-link { color: var(--blue); text-decoration: underline; text-decoration-style: dotted; cursor: pointer; }

    /* Sortable tables */
    table.sortable th:not(:empty) { cursor: pointer; user-select: none; }
    table.sortable th.sort-asc::after  { content: ' ‚Üë'; color: var(--blue); }
    table.sortable th.sort-desc::after { content: ' ‚Üì'; color: var(--blue); }
    table.sortable th.sort-asc,
    table.sortable th.sort-desc { color: var(--blue); }

    /* ‚îÄ‚îÄ Tent Matching ‚îÄ‚îÄ */
    .tent-layout { display: flex; min-height: calc(100vh - 56px); }
    .tent-sidebar {
      width: 220px; flex-shrink: 0; background: var(--card);
      border-right: 1px solid var(--border); padding: 14px 10px;
      display: flex; flex-direction: column; gap: 8px; overflow-y: auto;
    }
    .tent-main { flex: 1; padding: 20px; overflow-x: hidden; min-width: 0; }
    .btn-new-crew {
      display: flex; align-items: center; justify-content: center; gap: 5px;
      background: var(--blue); color: white; border: none;
      border-radius: 8px; padding: 8px 10px; font-size: 0.82rem; font-weight: 700;
      cursor: pointer; width: 100%;
    }
    .btn-new-crew:hover { background: var(--blue-light); }
    .crew-item {
      display: flex; align-items: center; gap: 7px; padding: 8px; border-radius: 8px;
      cursor: pointer; font-size: 0.83rem; font-weight: 600;
      border: 1.5px solid transparent; transition: all 0.12s;
    }
    .crew-item:hover { background: var(--bg); }
    .crew-item.active { background: #dbeafe; border-color: var(--blue); color: var(--blue); }
    .crew-item-name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .crew-dot { width: 9px; height: 9px; border-radius: 50%; flex-shrink: 0; }
    .crew-dot.valid   { background: var(--green); }
    .crew-dot.invalid { background: var(--red); }
    .crew-dot.unknown { background: #d1d5db; }
    .crew-count { font-size: 0.72rem; color: var(--muted); flex-shrink: 0; }
    .crew-item.active .crew-count { color: var(--blue); opacity: 0.8; }
    .tent-crew-name-input {
      flex: 1; font-size: 1.05rem; font-weight: 700; border: none;
      border-bottom: 2px solid var(--border); outline: none; padding: 2px 0;
      background: transparent; min-width: 0; color: #111827;
    }
    .tent-crew-name-input:focus { border-color: var(--blue); }
    .tent-scouts-list { display: flex; flex-direction: column; gap: 5px; min-height: 36px; }
    .tent-scout-row {
      display: flex; align-items: center; gap: 8px;
      padding: 8px 12px; background: var(--bg); border-radius: 8px; font-size: 0.85rem;
    }
    .tent-scout-name { font-weight: 600; flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .tent-scout-age   { color: var(--muted); font-size: 0.78rem; flex-shrink: 0; }
    .tent-scout-noage { color: #d97706; font-size: 0.73rem; flex-shrink: 0; }
    .btn-remove-scout {
      background: none; border: none; color: #9ca3af; cursor: pointer;
      font-size: 0.8rem; padding: 2px 5px; border-radius: 4px; flex-shrink: 0; line-height: 1;
    }
    .btn-remove-scout:hover { background: #fee2e2; color: var(--red); }
    .tent-actions { display: flex; gap: 8px; margin-top: 16px; flex-wrap: wrap; }
    .btn-tent { padding: 8px 16px; border-radius: 8px; font-size: 0.83rem; font-weight: 700; cursor: pointer; border: none; transition: all 0.12s; }
    .btn-tent-primary  { background: var(--blue); color: white; }
    .btn-tent-primary:hover:not(:disabled) { background: var(--blue-light); }
    .btn-tent-primary:disabled { background: #9ca3af; cursor: default; }
    .btn-tent-danger   { background: #fee2e2; color: #991b1b; border: 1.5px solid #fca5a5; }
    .btn-tent-danger:hover { background: #fca5a5; }
    .btn-tent-secondary { background: var(--bg); color: #374151; border: 1.5px solid var(--border); }
    .btn-tent-secondary:hover { border-color: #9ca3af; }
    .tent-results { margin-top: 20px; }
    .tent-result-banner {
      display: flex; align-items: center; gap: 8px; font-size: 0.9rem; font-weight: 700;
      padding: 10px 14px; border-radius: 8px; margin-bottom: 12px;
    }
    .tent-result-banner.valid   { background: #d1fae5; color: var(--green-light); border: 1px solid #6ee7b7; }
    .tent-result-banner.invalid { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
    .tent-group-list { display: flex; flex-direction: column; gap: 8px; }
    .tent-group {
      display: flex; align-items: center; gap: 12px; padding: 10px 14px;
      border-radius: 10px; border: 1.5px solid #6ee7b7; background: #f0fdf4;
    }
    .tent-group-label {
      font-size: 0.67rem; text-transform: uppercase; letter-spacing: 0.05em;
      color: var(--green-light); font-weight: 700; white-space: nowrap; text-align: center; min-width: 46px;
    }
    .tent-group-scouts { flex: 1; display: flex; flex-wrap: wrap; gap: 6px; }
    .tent-group-scout {
      background: #d1fae5; border-radius: 99px; padding: 3px 10px;
      font-size: 0.78rem; font-weight: 600; color: var(--green-light);
    }
    .tent-group-age-range { font-size: 0.72rem; color: var(--green-light); white-space: nowrap; opacity: 0.8; }
    .tent-reason {
      background: #fff7ed; border: 1px solid #fed7aa; border-radius: 8px;
      padding: 10px 14px; font-size: 0.82rem; color: #9a3412; line-height: 1.5;
    }
    .tent-toolbar {
      display: flex; align-items: center; gap: 10px; flex-wrap: wrap; margin-bottom: 18px;
    }
    .tent-summary {
      font-size: 0.82rem; color: var(--muted); margin-bottom: 14px;
      display: flex; align-items: center; gap: 6px; flex-wrap: wrap;
    }
    .tent-crews-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
      gap: 18px;
      align-items: start;
    }
    .tent-crew-card .panel-body { padding: 14px 16px; }

    /* Tent pool collapsible */
    .tent-pool-details { margin-bottom: 14px; }
    .tent-pool-details > .tent-scout-pool { margin-bottom: 0; margin-top: 6px; }
    .tent-pool-summary {
      font-size: 0.72rem; font-weight: 700; text-transform: uppercase;
      letter-spacing: 0.05em; color: #6b7280; cursor: pointer;
      list-style: none; display: flex; align-items: center; gap: 5px;
      user-select: none; padding: 2px 0;
    }
    .tent-pool-summary::-webkit-details-marker { display: none; }
    .tent-pool-summary::before { content: '‚ñ∂'; font-size: 0.55rem; transition: transform 0.15s; }
    .tent-pool-details[open] > .tent-pool-summary::before { transform: rotate(90deg); }

    /* Tent scout pool (persistent scrollable list) */
    .tent-scout-pool { margin-bottom: 14px; }
    .pool-sort-bar {
      display: flex; align-items: center; gap: 5px; margin-bottom: 5px;
    }
    .pool-sort-label { font-size: 0.72rem; color: var(--muted); }
    .pool-sort-btn {
      font-size: 0.72rem; padding: 2px 8px; border-radius: 99px; border: 1.5px solid var(--border);
      background: white; color: #374151; cursor: pointer; font-weight: 600;
    }
    .pool-sort-btn.active { background: var(--blue); color: white; border-color: var(--blue); }
    .pool-sort-btn:not(.active):hover { border-color: #9ca3af; }
    .tent-pool-filter {
      width: 100%; padding: 6px 10px; border: 1.5px solid var(--border);
      border-radius: 8px; font-size: 0.82rem; background: white; color: #111827;
      box-sizing: border-box; margin-bottom: 6px; outline: none;
    }
    .tent-pool-filter:focus { border-color: var(--blue); }
    .tent-pool-list {
      max-height: 220px; overflow-y: auto; border: 1.5px solid var(--border);
      border-radius: 8px; background: white;
    }
    .pool-scout {
      display: flex; align-items: center; gap: 8px;
      padding: 7px 10px; cursor: pointer; font-size: 0.82rem;
      border-bottom: 1px solid #f3f4f6; transition: background 0.1s;
      user-select: none;
    }
    .pool-scout:last-child { border-bottom: none; }
    .pool-scout.ps-in { background: #f0fdf4; color: #166534; }
    .pool-scout.ps-in:hover { background: #dcfce7; }
    .pool-scout.ps-avail:hover { background: var(--bg); }
    .pool-scout-icon { font-size: 0.78rem; width: 14px; flex-shrink: 0; text-align: center; }
    .pool-scout-name { flex: 1; font-weight: 500; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .pool-scout-age { font-size: 0.73rem; opacity: 0.7; flex-shrink: 0; }
    .pool-other-note {
      padding: 6px 10px; font-size: 0.72rem; color: var(--muted);
      border-top: 1px solid var(--border); text-align: center; font-style: italic;
    }
    .tent-partial-section { margin-top: 10px; }
    .tent-partial-label {
      font-size: 0.7rem; font-weight: 700; text-transform: uppercase;
      letter-spacing: 0.05em; color: #6b7280; margin-bottom: 6px;
    }
    .tent-incompatible-list { display: flex; flex-wrap: wrap; gap: 6px; }
    .tent-incompatible-scout {
      background: #fee2e2; border-radius: 99px; padding: 3px 10px;
      font-size: 0.78rem; font-weight: 600; color: #991b1b;
    }

    /* ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ */
    @media (max-width: 900px) {
      .panels-pair { flex-direction: column; }
    }
    @media (max-width: 680px) {
      .scout-layout { flex-direction: column; }
      .scout-sidebar { width: 100%; border-right: none; border-bottom: 1px solid var(--border); padding: 12px 14px; }
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
      .eagle-grid { grid-template-columns: repeat(2, 1fr); }
      .panel-sub { display: none !important; }
    }
    @media (max-width: 520px) {
      /* Tighter header */
      header { padding: 0 10px; gap: 8px; }
      .tab-btn { padding: 6px 10px; font-size: 0.8rem; letter-spacing: 0; }
      /* Tighter content areas */
      .troop-main { padding: 10px; }
      .scout-main { padding: 10px; }
      .panel-body { padding: 10px 12px; }
      .panel-header { padding: 10px 14px; }
      .panels-pair { gap: 10px; }
      .panels-col  { gap: 10px; }
      .panels-grid { gap: 10px; }
      .stats-grid { gap: 10px; margin-bottom: 14px; }
      .stat-card { padding: 14px; }
      .stat-value { font-size: 1.6rem; }
      /* DB / Settings cards */
      .db-card { padding: 24px 20px; }
      .db-info-card { padding: 20px !important; }
      /* Hide bar-chart columns in tables ‚Äî visual summary, not critical data */
      .bar-cell { display: none !important; }
      /* Hide other low-priority elements flagged in templates */
      .hide-sm { display: none !important; }
    }
  </style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<header>
  <div class="logo">
    <span class="logo-icon">‚öúÔ∏è</span>
    <span id="header-title">Scouting Stats</span>
    <span id="header-sync-label" style="font-size:0.68rem;font-weight:400;opacity:0.65;white-space:nowrap;display:none"></span>
  </div>
  <nav class="main-tabs">
    <button class="tab-btn active" data-view="troop" onclick="switchView('troop',this)">Troop</button>
    <button class="tab-btn" data-view="roster" onclick="switchView('roster',this)">Roster</button>
    <button class="tab-btn" data-view="scout" onclick="switchView('scout',this)">Scout</button>
    <button class="tab-btn" data-view="tents" onclick="switchView('tents',this)">Tents</button>
    <button class="tab-btn" data-view="db" id="db-tab" onclick="switchView('db',this)">Settings</button>
  </nav>
</header>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DB VIEW ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="view" id="view-db">
  <div class="db-view-content">
    <div class="db-card">
      <div class="db-card-icon">üóÑÔ∏è</div>
      <h2>Load Database</h2>
      <p>Open your <code>scouting_troop.db</code> file, or serve this page over HTTP to auto-load it from the same directory.</p>
      <label class="file-label" for="db-file">üìÇ Open Database</label>
      <input type="file" id="db-file" accept=".db,.sqlite,.sqlite3">
      <div id="db-status"></div>
    </div>
    <div class="db-card db-info-card" id="db-info-card" style="display:none">
      <h2>üìä Database Info</h2>
      <div id="db-info-content"></div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SCOUT VIEW ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="view" id="view-scout">
  <div class="scout-layout">

    <aside class="scout-sidebar">
      <div class="sidebar-label">Select Scout</div>
      <div class="scout-picker" id="scout-picker">
        <div class="pool-sort-bar">
          <span class="pool-sort-label">Sort:</span>
          <button class="pool-sort-btn active" data-sort="last" onclick="_sortScoutList('last')">Last ‚Üë</button>
          <button class="pool-sort-btn" data-sort="first" onclick="_sortScoutList('first')">First</button>
        </div>
        <input type="text" id="scout-filter" class="scout-filter-input"
          placeholder="Load a database first‚Ä¶" autocomplete="off" disabled
          oninput="_filterScoutList()">
        <div class="scout-list" id="scout-list"></div>
      </div>
    </aside>

    <div class="scout-main">
      <div id="scout-content">
        <div class="empty-state">
          <div class="ei">‚öúÔ∏è</div>
          <p>Load a database file and select a Scout to view their individual record and advancement status.</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TROOP VIEW ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="view active" id="view-troop">
  <div class="troop-main">
    <div id="troop-content">
      <div class="empty-state">
        <div class="ei">‚öúÔ∏è</div>
        <p>Load a database file to see troop-wide statistics, Eagle MB gaps, activity planning, and roster summaries.</p>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ROSTER VIEW ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="view" id="view-roster">
  <div class="troop-main">
    <div id="roster-content">
      <div class="empty-state">
        <div class="ei">‚öúÔ∏è</div>
        <p>Load a database file to see the troop roster.</p>
      </div>
    </div>
  </div>
</div>


<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TENT MATCHING VIEW ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="view" id="view-tents">
  <div class="tent-main">
    <div class="tent-toolbar">
      <button class="btn-new-crew" style="width:auto;padding:7px 16px" onclick="addTentCrew()">+ New Crew</button>
      <button class="btn-tent btn-tent-primary" id="tent-analyze-all-btn" onclick="tentAnalyzeAll()" style="display:none">‚õ∫ Analyze All</button>
    </div>
    <div id="tent-editor">
      <div class="empty-state">
        <div class="ei">‚õ∫</div>
        <p>Load a database and create a crew to start building tent arrangements.</p>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MB DETAIL MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="mb-modal" class="mb-modal-overlay" onclick="if(event.target===this)closeMBModal()">
  <div class="mb-modal">
    <div class="mb-modal-header">
      <div style="flex:1;min-width:0">
        <div style="display:flex;align-items:center;gap:8px">
          <span style="font-size:1rem">üéñÔ∏è</span>
          <h2 id="mb-modal-title" style="font-size:1.05rem;font-weight:700"></h2>
        </div>
        <div id="mb-modal-status" style="display:flex;align-items:center;gap:8px;margin-top:5px;flex-wrap:wrap"></div>
      </div>
      <button class="mb-modal-close" onclick="closeMBModal()" title="Close (Esc)">‚úï</button>
    </div>
    <div id="mb-modal-progress"></div>
    <div id="mb-modal-body" class="mb-modal-body"></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê EAGLE PIPELINE MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="pipeline-modal" class="mb-modal-overlay" onclick="if(event.target===this)closePipelineModal()">
  <div class="mb-modal" style="max-width:860px">
    <div class="mb-modal-header">
      <div style="flex:1;min-width:0">
        <div style="display:flex;align-items:center;gap:8px">
          <span style="font-size:1rem">ü¶Ö</span>
          <h2 id="pipeline-modal-title" style="font-size:1.05rem;font-weight:700"></h2>
        </div>
        <div id="pipeline-modal-sub" style="margin-top:5px;font-size:0.78rem;color:var(--muted)"></div>
      </div>
      <button class="mb-modal-close" onclick="closePipelineModal()" title="Close (Esc)">‚úï</button>
    </div>
    <div id="pipeline-modal-body" class="mb-modal-body"></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TROOP MB PARTICIPATION MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="troop-mb-modal" class="mb-modal-overlay" onclick="if(event.target===this)closeTroopMBModal()">
  <div class="mb-modal">
    <div class="mb-modal-header">
      <div style="flex:1;min-width:0">
        <div style="display:flex;align-items:center;gap:8px">
          <span style="font-size:1rem">üéñÔ∏è</span>
          <h2 id="troop-mb-modal-title" style="font-size:1.05rem;font-weight:700"></h2>
        </div>
        <div id="troop-mb-modal-sub" style="margin-top:5px;font-size:0.78rem;color:var(--muted)"></div>
      </div>
      <button class="mb-modal-close" onclick="closeTroopMBModal()" title="Close (Esc)">‚úï</button>
    </div>
    <div id="troop-mb-modal-body" class="mb-modal-body"></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SCRIPTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.2/sql-wasm.js"></script>
<script>
'use strict';

// ‚îÄ‚îÄ‚îÄ Eagle Scout requirement structure ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Source: https://www.scouting.org/skills/merit-badges/eagle-required/
// Eagle rank requires 21 total merit badges, of which 14 must fill these slots:
//   11 mandatory badges (all required) + 3 "choose one" group slots
const EAGLE_MANDATORY = [
  'Camping', 'Citizenship in the Community', 'Citizenship in the Nation',
  'Citizenship in Society', 'Citizenship in the World', 'Communication',
  'Cooking', 'Family Life', 'First Aid', 'Personal Fitness', 'Personal Management',
];
const EAGLE_CHOICE_GROUPS = [
  { label: 'Emergency Preparedness or Lifesaving',  badges: ['Emergency Preparedness', 'Lifesaving'] },
  { label: 'Environmental Science or Sustainability', badges: ['Environmental Science', 'Sustainability'] },
  { label: 'Swimming, Hiking, or Cycling',            badges: ['Swimming', 'Hiking', 'Cycling'] },
];
const EAGLE_SLOT_COUNT = 14; // 11 mandatory + 3 choice group slots
const EAGLE_TOTAL_MBS  = 21; // total merit badges required for Eagle Scout rank

// Returns { slotsDone, slotsInProg } given a map of { badgeName -> status }
function calcEagleSlots(statusMap) {
  const mandatoryDone   = EAGLE_MANDATORY.filter(b => statusMap[b] === 'completed').length;
  const choicesDone     = EAGLE_CHOICE_GROUPS.filter(g => g.badges.some(b => statusMap[b] === 'completed')).length;
  const mandatoryInProg = EAGLE_MANDATORY.filter(b => statusMap[b] === 'in_progress').length;
  // A choice slot counts as in-progress only if not satisfied but at least one option is started
  const choicesInProg   = EAGLE_CHOICE_GROUPS.filter(g =>
    !g.badges.some(b => statusMap[b] === 'completed') &&
     g.badges.some(b => statusMap[b] === 'in_progress')
  ).length;
  return { slotsDone: mandatoryDone + choicesDone, slotsInProg: mandatoryInProg + choicesInProg };
}

// ‚îÄ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let db              = null;
let SQL             = null;
let currentScoutId  = null;
let hasPatrolCol    = false;

// ‚îÄ‚îÄ‚îÄ SQL helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function q(sql, params = []) {
  if (!db) return [];
  try {
    const stmt = db.prepare(sql);
    const rows = [];
    stmt.bind(params);
    while (stmt.step()) rows.push(stmt.getAsObject());
    stmt.free();
    return rows;
  } catch (e) {
    console.error('Query error:', e.message, '\nSQL:', sql);
    return [];
  }
}

function q1(sql, params = []) {
  const r = q(sql, params);
  return r.length ? r[0] : null;
}

// ‚îÄ‚îÄ‚îÄ Panel layout (masonry-style two-column via flexbox) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function relayoutPanels(root) {
  root.querySelectorAll('.panels-grid').forEach(grid => {
    const items = Array.from(grid.children);
    if (items.every(el => el.classList.contains('panel-full'))) return;

    const left  = document.createElement('div');
    left.className = 'panels-col';
    const right = document.createElement('div');
    right.className = 'panels-col';
    items.forEach((item, i) => (i % 2 === 0 ? left : right).appendChild(item));

    const pair = document.createElement('div');
    pair.className = 'panels-pair';
    pair.appendChild(left);
    pair.appendChild(right);

    grid.innerHTML = '';
    grid.appendChild(pair);
  });
}

// ‚îÄ‚îÄ‚îÄ View switching ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function switchView(name, btn) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('view-' + name).classList.add('active');
  btn.classList.add('active');
  if (name === 'troop' && db) loadTroopView();
  if (name === 'roster' && db) loadRosterView();
  if (name === 'tents') loadTentView();
  localStorage.setItem('activeTab', name);
}

// ‚îÄ‚îÄ‚îÄ Sortable tables ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener('click', function(e) {
  const th = e.target.closest('th');
  if (!th || !th.textContent.trim()) return;
  const table = th.closest('table.sortable');
  if (!table) return;
  const tbody = table.querySelector('tbody');
  if (!tbody) return;

  const ths = Array.from(th.closest('tr').querySelectorAll('th'));
  const colIdx = ths.indexOf(th);
  const goDesc = th.classList.contains('sort-asc');

  table.querySelectorAll('th').forEach(t => t.classList.remove('sort-asc', 'sort-desc'));
  th.classList.add(goDesc ? 'sort-desc' : 'sort-asc');

  const dir = goDesc ? -1 : 1;
  Array.from(tbody.querySelectorAll('tr'))
    .sort((a, b) => {
      const aText = (a.querySelectorAll('td')[colIdx]?.textContent ?? '').trim().replace(/[%,]/g, '');
      const bText = (b.querySelectorAll('td')[colIdx]?.textContent ?? '').trim().replace(/[%,]/g, '');
      const aNum = parseFloat(aText);
      const bNum = parseFloat(bText);
      if (!isNaN(aNum) && !isNaN(bNum)) return dir * (aNum - bNum);
      return dir * aText.localeCompare(bText);
    })
    .forEach(r => tbody.appendChild(r));
});

function goToScout(userId) {
  const scoutTab = document.querySelector('.tab-btn[data-view="scout"]');
  switchView('scout', scoutTab);
  _selectScout(userId);
  const activeItem = document.querySelector('.scout-list-item.active');
  if (activeItem) activeItem.scrollIntoView({ block: 'nearest' });
}

document.addEventListener('keydown', function(e) {
  if (e.key !== 'ArrowLeft' && e.key !== 'ArrowRight') return;
  if (!document.getElementById('view-scout').classList.contains('active')) return;
  if (document.activeElement === document.getElementById('scout-filter')) return;
  if (_scoutList.length === 0) return;
  e.preventDefault();
  const idx = _scoutList.findIndex(s => s.user_id === currentScoutId);
  const next = e.key === 'ArrowRight'
    ? (idx < 0 ? 0 : (idx + 1) % _scoutList.length)
    : (idx < 0 ? _scoutList.length - 1 : (idx - 1 + _scoutList.length) % _scoutList.length);
  _selectScout(_scoutList[next].user_id);
  const activeItem = document.querySelector('.scout-list-item.active');
  if (activeItem) activeItem.scrollIntoView({ block: 'nearest' });
});

// ‚îÄ‚îÄ‚îÄ DB loading ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function initSQL() {
  if (SQL) return;
  SQL = await initSqlJs({
    locateFile: f => 'https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.2/' + f
  });
}

async function loadDbBuffer(buf, filename) {
  const status = document.getElementById('db-status');
  await initSQL();
  db = new SQL.Database(new Uint8Array(buf));
  _tentInitialized = false;

  // Quick sanity check
  const row = q1("SELECT COUNT(*) AS n FROM sqlite_master WHERE type='table' AND name='scouts'");
  if (!row || row.n === 0) throw new Error('This does not look like a scouting_troop.db file (scouts table not found)');

  const scouts = q1('SELECT COUNT(*) AS n FROM scouts');
  const scoutCount = scouts ? scouts.n : 0;

  status.innerHTML = `‚úì <strong>${esc(filename)}</strong> ‚Äî ${scoutCount} Scout${scoutCount !== 1 ? 's' : ''} loaded`;

  const hasSettings = q1("SELECT COUNT(*) AS n FROM sqlite_master WHERE type='table' AND name='settings'");
  const troopNameRow = hasSettings && hasSettings.n ? q1("SELECT value FROM settings WHERE key = 'troop_name'") : null;
  const troopName = troopNameRow ? troopNameRow.value : null;
  const titleText = troopName ? `Scouting Stats: ${troopName}` : 'Scouting Stats';
  document.getElementById('header-title').textContent = titleText;
  document.title = titleText;

  const lastSyncRow = q1('SELECT MAX(last_synced_at) AS d FROM scouts');
  const lastSync = lastSyncRow ? lastSyncRow.d : null;
  const lastSyncText = lastSync ? 'Data loaded ' + fmtDt(lastSync) : null;
  const syncLabelEl = document.getElementById('header-sync-label');
  if (lastSyncText) { syncLabelEl.textContent = lastSyncText; syncLabelEl.style.display = ''; }
  else { syncLabelEl.style.display = 'none'; }

  hasPatrolCol = q("PRAGMA table_info(scouts)").some(c => c.name === 'patrol');

  // Populate the Settings info card
  const DB_TABLES = [
    { label: 'Scouts',                   table: 'scouts' },
    { label: 'Ranks',                    table: 'ranks' },
    { label: 'Merit Badges',             table: 'merit_badges' },
    { label: 'Scout Advancements',       table: 'scout_advancements' },
    { label: 'Scout Merit Badges',       table: 'scout_merit_badges' },
    { label: 'Rank Requirements',        table: 'requirements' },
    { label: 'Scout Rank Completions',   table: 'scout_requirement_completions' },
    { label: 'MB Requirements',          table: 'mb_requirements' },
    { label: 'Scout MB Completions',     table: 'scout_mb_requirement_completions' },
    { label: 'Leadership Records',       table: 'scout_leadership' },
  ];
  const tableRows = DB_TABLES.map(({ label, table }) => {
    const exists = q1(`SELECT COUNT(*) AS n FROM sqlite_master WHERE type='table' AND name='${table}'`);
    const count = (exists && exists.n) ? (q1(`SELECT COUNT(*) AS n FROM ${table}`) || {n:0}).n : 0;
    return `<tr><td>${esc(label)}</td><td>${count.toLocaleString()}</td></tr>`;
  }).join('');
  document.getElementById('db-info-content').innerHTML =
    (troopName ? `<div class="db-info-troop"><div class="label">Troop</div><div class="value">${esc(troopName)}</div></div>` : '') +
    (lastSyncText ? `<div class="db-info-troop"><div class="label">Last Sync</div><div class="value">${esc(lastSyncText.replace('Data loaded ', ''))}</div></div>` : '') +
    `<table class="db-stats-table">
      <thead><tr><th>Table</th><th>Rows</th></tr></thead>
      <tbody>${tableRows}</tbody>
    </table>`;
  document.getElementById('db-info-card').style.display = '';

  loadScoutList();
  // Restore last-used tab, falling back to Troop
  const savedTab = localStorage.getItem('activeTab') || 'troop';
  const tabBtn = document.querySelector(`.tab-btn[data-view="${savedTab}"]`)
              || document.querySelector('.tab-btn[data-view="troop"]');
  switchView(savedTab, tabBtn);
}

document.getElementById('db-file').addEventListener('change', async function (e) {
  const file = e.target.files[0];
  if (!file) return;
  const status = document.getElementById('db-status');
  status.textContent = 'Loading‚Ä¶';
  try {
    const buf = await file.arrayBuffer();
    await loadDbBuffer(buf, file.name);
  } catch (err) {
    status.textContent = '‚ö† ' + err.message;
    console.error(err);
  }
});

// Auto-load scouting_troop.db from the same directory (works when served over HTTP)
(async () => {
  const status = document.getElementById('db-status');
  try {
    await initSQL();
    const resp = await fetch('./scouting_troop.db');
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    const buf = await resp.arrayBuffer();
    await loadDbBuffer(buf, 'scouting_troop.db');
  } catch {
    status.innerHTML = 'Auto-load failed ‚Äî use the button above to open <strong>scouting_troop.db</strong> manually.';
  }
})();

// ‚îÄ‚îÄ‚îÄ Scout list picker ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _scoutList = [];   // [{user_id, first_name, last_name, name}]
let _scoutSort    = 'last'; // 'last' | 'first'
let _scoutSortDir = 'asc';  // 'asc'  | 'desc'

function _renderScoutList() {
  const list = document.getElementById('scout-list');
  if (!list) return;
  list.innerHTML = _scoutList.map(s =>
    `<div class="scout-list-item${s.user_id === currentScoutId ? ' active' : ''}"
      data-uid="${s.user_id}" data-name="${s.name.toLowerCase()}"
      onclick="_selectScout(${s.user_id})">${esc(s.name)}</div>`
  ).join('');
}

function _filterScoutList() {
  const input = document.getElementById('scout-filter');
  const list  = document.getElementById('scout-list');
  if (!input || !list) return;
  const val = input.value.trim().toLowerCase();
  list.querySelectorAll('.scout-list-item').forEach(el => {
    el.style.display = !val || el.dataset.name.includes(val) ? '' : 'none';
  });
}

function _applySortScoutList() {
  const dir = _scoutSortDir === 'asc' ? 1 : -1;
  _scoutList.sort((a, b) => dir * (_scoutSort === 'first'
    ? a.first_name.localeCompare(b.first_name) || a.last_name.localeCompare(b.last_name)
    : a.last_name.localeCompare(b.last_name)   || a.first_name.localeCompare(b.first_name)));
  document.querySelectorAll('[data-sort]').forEach(btn => {
    const active = btn.dataset.sort === _scoutSort;
    btn.classList.toggle('active', active);
    const label = btn.dataset.sort === 'last' ? 'Last' : 'First';
    btn.textContent = active ? `${label} ${_scoutSortDir === 'asc' ? '‚Üë' : '‚Üì'}` : label;
  });
}

function _sortScoutList(by) {
  if (by === _scoutSort) {
    _scoutSortDir = _scoutSortDir === 'asc' ? 'desc' : 'asc';
  } else {
    _scoutSort = by;
    _scoutSortDir = 'asc';
  }
  _applySortScoutList();
  _renderScoutList();
  _filterScoutList();
}

function _selectScout(uid) {
  loadScout(uid);
  document.querySelectorAll('.scout-list-item').forEach(el => {
    el.classList.toggle('active', Number(el.dataset.uid) === Number(uid));
  });
}

// ‚îÄ‚îÄ‚îÄ Scout View ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loadScoutList() {
  const rows = q("SELECT user_id, COALESCE(first_name,'') AS first_name, COALESCE(last_name,'') AS last_name FROM scouts");
  _scoutList = rows.map(r => ({...r, name: (r.first_name + ' ' + r.last_name).trim()}));
  _applySortScoutList();
  const input = document.getElementById('scout-filter');
  input.disabled = false;
  input.value = '';
  input.placeholder = _scoutList.length ? `Filter ${_scoutList.length} scouts‚Ä¶` : 'No Scouts found';
  _renderScoutList();
}

function loadScout(userId) {
  currentScoutId = userId || null;
  if (!userId) {
    document.getElementById('scout-content').innerHTML =
      '<div class="empty-state"><div class="ei">‚öúÔ∏è</div><p>Select a Scout from the list.</p></div>';
    return;
  }

  // ‚îÄ‚îÄ Queries ‚îÄ‚îÄ
  const patrolSel = hasPatrolCol ? 's.patrol,' : 'NULL AS patrol,';
  const ov = q1(`
    SELECT s.user_id,
      TRIM(COALESCE(s.first_name,'') || ' ' || COALESCE(s.last_name,'')) AS scout_name,
      s.scouting_member_id, s.birthdate, s.last_synced_at, ${patrolSel}
      COALESCE(r.name, 'New Scout') AS current_rank,
      r.level AS rank_level,
      (SELECT date_completed FROM scout_advancements
         WHERE scout_user_id = s.user_id AND advancement_type = 'rank' AND status = 'completed'
         ORDER BY advancement_id DESC LIMIT 1) AS last_rank_date,
      (SELECT COUNT(*) FROM scout_merit_badges smb
         WHERE smb.scout_user_id = s.user_id AND smb.status = 'completed') AS total_mbs,
      (SELECT COUNT(*) FROM scout_merit_badges smb
         JOIN merit_badges mb ON mb.name = smb.merit_badge_name
         WHERE smb.scout_user_id = s.user_id AND smb.status = 'completed' AND mb.is_eagle_required = 1) AS eagle_mbs,
      (SELECT COUNT(*) FROM scout_merit_badges smb
         WHERE smb.scout_user_id = s.user_id AND smb.status = 'in_progress') AS mbs_in_progress,
      (SELECT COUNT(*) FROM scout_leadership sl WHERE sl.scout_user_id = s.user_id) AS leadership_count,
      (SELECT SUM(COALESCE(days_in_position,0)) FROM scout_leadership sl
         WHERE sl.scout_user_id = s.user_id AND sl.approved = 1) AS leadership_days
    FROM scouts s LEFT JOIN ranks r ON r.id = s.current_rank_id
    WHERE s.user_id = ?`, [userId]);

  if (!ov) return;

  // Fetch status for every badge in the Eagle pool (mandatory + all choice options)
  const eagleMBs = q(`
    SELECT mb.name, COALESCE(smb.status, 'needed') AS status, smb.date_completed
    FROM merit_badges mb
    LEFT JOIN scout_merit_badges smb ON smb.merit_badge_name = mb.name AND smb.scout_user_id = ?
    WHERE mb.is_eagle_required = 1
    ORDER BY mb.name`, [userId]);

  // Per-badge requirement progress (only rows where requirements have been synced)
  const mbReqProgress = q(`
    SELECT mb.name AS mb_name,
      COUNT(mr.id) AS total_reqs,
      COALESCE(SUM(CASE WHEN smrc.completed = 1 THEN 1 ELSE 0 END), 0) AS done_reqs
    FROM merit_badges mb
    JOIN scout_merit_badges smb
      ON smb.merit_badge_name = mb.name AND smb.scout_user_id = ?
      AND smb.raw_json IS NOT NULL
    JOIN mb_requirements mr
      ON mr.mb_api_id = CAST(json_extract(smb.raw_json, '$.id') AS INTEGER)
      AND mr.parent_requirement_id IS NULL
    LEFT JOIN scout_mb_requirement_completions smrc
      ON smrc.mb_requirement_id = mr.id AND smrc.scout_user_id = ?
    WHERE mb.is_eagle_required = 1
    GROUP BY mb.name`, [userId, userId]);
  const eagleProgMap = {};
  mbReqProgress.forEach(r => { eagleProgMap[r.mb_name] = { done: r.done_reqs, total: r.total_reqs }; });

  const nextReqs = q(`
    WITH cs AS (
      SELECT s.current_rank_id, COALESCE(r.level, 0) AS lvl
      FROM scouts s LEFT JOIN ranks r ON r.id = s.current_rank_id
      WHERE s.user_id = ?
    ),
    nr AS (
      SELECT r.id, r.name FROM ranks r, cs
      WHERE r.program_id = 2 AND r.level = cs.lvl + 1
      LIMIT 1
    )
    SELECT nr.name AS next_rank_name,
      r.requirement_number,
      COALESCE(r.short, SUBSTR(r.name, 1, 80)) AS desc,
      r.name AS full_name,
      COALESCE(src.completed, 0) AS completed,
      src.date_completed
    FROM nr
    JOIN requirements r ON r.rank_id = nr.id AND r.required = 1 AND r.parent_requirement_id IS NULL
    LEFT JOIN scout_requirement_completions src
      ON src.requirement_id = r.id AND src.scout_user_id = ?
    ORDER BY r.sort_order, r.requirement_number`, [userId, userId]);

  const allMBs = q(`
    SELECT merit_badge_name, status, date_completed, date_started
    FROM scout_merit_badges WHERE scout_user_id = ?
    ORDER BY
      CASE status WHEN 'completed' THEN 0 ELSE 1 END,
      merit_badge_name`, [userId]);

  const leadership = q(`
    SELECT position, start_date, end_date, days_in_position, approved, patrol, unit
    FROM scout_leadership WHERE scout_user_id = ?
    ORDER BY start_date DESC`, [userId]);

  const rankHistory = q(`
    SELECT advancement_name, status, date_completed, advancement_id
    FROM scout_advancements WHERE scout_user_id = ? AND advancement_type = 'rank'
    ORDER BY advancement_id`, [userId]);

  const allRanks = q(`SELECT id, name, level FROM ranks WHERE program_id = 2 ORDER BY level`);

  // ‚îÄ‚îÄ Derived stats ‚îÄ‚îÄ
  const mbStatusMap = {};
  eagleMBs.forEach(m => { mbStatusMap[m.name] = m.status; });
  const { slotsDone, slotsInProg } = calcEagleSlots(mbStatusMap);
  const slotPct = Math.round(slotsDone * 100 / EAGLE_SLOT_COUNT);

  const nextDone  = nextReqs.filter(r => r.completed).length;
  const nextTotal = nextReqs.length;
  const nextPct   = nextTotal > 0 ? Math.round(nextDone * 100 / nextTotal) : 0;
  const nextName  = nextReqs.length > 0 ? nextReqs[0].next_rank_name : null;

  const earnedMBs    = allMBs.filter(m => m.status === 'completed');
  const inProgMBs    = allMBs.filter(m => m.status !== 'completed');

  const earnedRankSet = new Set(rankHistory.filter(r => r.status === 'completed').map(r => r.advancement_name));
  const curLevel      = ov.rank_level || 0;

  // ‚îÄ‚îÄ Scout summary card (first item in stats-grid) ‚îÄ‚îÄ
  const metaHtml = `
    <div class="stat-card">
      <div class="stat-label">Summary</div>
      ${ov.patrol ? `<div style="margin:4px 0 2px"><span class="pill pill-blue" style="font-size:0.78rem">‚öë ${esc(ov.patrol)}</span></div>` : ''}
      <div class="stat-sub">${[
        ov.birthdate ? `${fmtDate(ov.birthdate)}${calcAge(ov.birthdate) !== null ? ` (age ${calcAge(ov.birthdate)})` : ''}` : '',
        `ID ${esc(String(ov.user_id))}`,
        ov.scouting_member_id ? `Member ${esc(String(ov.scouting_member_id))}` : '',
        ov.leadership_days ? `${ov.leadership_days} days leadership` : '',
      ].filter(Boolean).join(' ¬∑ ')}</div>
    </div>`;

  // ‚îÄ‚îÄ Render ‚îÄ‚îÄ
  document.getElementById('scout-content').innerHTML = `

    <!-- Stat Cards + Meta -->
    <div class="stats-grid">
      ${metaHtml}
      <div class="stat-card">
        <div class="stat-label">Rank</div>
        <div class="stat-value" style="font-size:1.2rem;line-height:1.2">${esc(ov.current_rank)}</div>
        <div class="stat-sub">${ov.last_rank_date ? 'Earned ' + fmtDate(ov.last_rank_date) : 'No date recorded'}</div>
      </div>
      <div class="stat-card gold">
        <div class="stat-label">Eagle Slots</div>
        <div class="stat-value">${slotsDone}<span style="font-size:1rem;font-weight:500"> / ${EAGLE_SLOT_COUNT}</span></div>
        <div class="prog-bar"><div class="prog-fill gold" style="width:${slotPct}%"></div></div>
        <div class="stat-sub">${slotPct}%${slotsInProg ? ' ¬∑ ' + slotsInProg + ' in progress' : ''}</div>
      </div>
      <div class="stat-card green">
        <div class="stat-label">Merit Badges</div>
        <div class="stat-value">${ov.total_mbs || 0}</div>
        <div class="stat-sub">${ov.mbs_in_progress || 0} in progress</div>
      </div>
    </div>

    <!-- Rank Pipeline -->
    <div class="panel panel-full" style="margin-bottom:18px">
      <div class="panel-header">
        <span class="panel-icon">üèÖ</span><h2>Rank Progress</h2>
        ${nextTotal > 0
          ? `<span class="pill pill-blue" style="margin-left:auto">${nextName ? esc(nextName) + ' ¬∑ ' : ''}${nextDone} / ${nextTotal} requirements ¬∑ ${nextPct}%</span>`
          : nextName ? `<span class="pill" style="margin-left:auto;background:var(--bg);color:var(--muted)">No requirement data for ${esc(nextName)}</span>` : ''}
      </div>
      <div class="panel-body">
        <div class="pipeline-wrap">
          <div class="pipeline">
            ${allRanks.map(rank => {
              const done    = earnedRankSet.has(rank.name);
              const current = rank.level === curLevel;
              const next    = rank.level === curLevel + 1;
              return `<div class="pipe-step ${done ? 'done' : ''}">
                <div class="pipe-dot ${done ? 'done' : current ? 'current' : next ? 'next' : ''}">
                  ${done ? '‚úì' : rank.level}
                </div>
                <div class="pipe-label ${done ? 'done' : current ? 'current' : ''}">${esc(rank.name)}</div>
              </div>`;
            }).join('')}
          </div>
        </div>
      </div>
    </div>

    <!-- Two-column panels -->
    <div class="panels-grid">

      <!-- Eagle MB Checklist -->
      <div class="panel">
        <div class="panel-header">
          <span class="panel-icon">‚≠ê</span>
          <h2>Eagle Merit Badge Checklist</h2>
          <span class="pill pill-gold" style="margin-left:auto">${slotsDone} / ${EAGLE_SLOT_COUNT} slots ¬∑ ${ov.total_mbs || 0}/${EAGLE_TOTAL_MBS} MBs</span>
        </div>
        <div class="panel-body">
          <!-- 11 Required badges -->
          <div class="choice-section-label">Required ‚Äî all 11 must be earned</div>
          <div class="eagle-grid">
            ${EAGLE_MANDATORY.map(name => {
              const mb = eagleMBs.find(m => m.name === name) || { name, status: 'needed', date_completed: null };
              const prog = eagleProgMap[name];
              const progStr = (prog && prog.total > 0) ? `<span style="font-size:0.65rem;opacity:0.75;margin-left:4px">${prog.done}/${prog.total}</span>` : '';
              return `<div class="eagle-item ${mb.status === 'completed' ? 'earned' : mb.status === 'in_progress' ? 'progress' : 'needed'}" style="cursor:pointer" onclick="showMBDetail(${esc(JSON.stringify(name))})">
                <span class="ei-icon">${mb.status === 'completed' ? '‚úÖ' : mb.status === 'in_progress' ? 'üîÑ' : '‚óã'}</span>
                <span>${esc(name)}${mb.date_completed && mb.status === 'completed' ? `<br><span style="font-size:0.65rem;opacity:0.7">${fmtDate(mb.date_completed)}</span>` : progStr ? `<br>${progStr}` : ''}</span>
              </div>`;
            }).join('')}
          </div>
          <!-- 3 Choice groups -->
          <div class="choice-section-label" style="margin-top:16px">Choose One from Each Group ‚Äî 3 additional slots</div>
          ${EAGLE_CHOICE_GROUPS.map(group => {
            const gMBs = group.badges.map(name => {
              const mb = eagleMBs.find(m => m.name === name) || { name, status: 'needed', date_completed: null };
              return { ...mb, name };
            });
            const satisfied  = gMBs.some(m => m.status === 'completed');
            const inProgress = !satisfied && gMBs.some(m => m.status === 'in_progress');
            const cls   = satisfied ? 'cg-satisfied' : inProgress ? 'cg-progress' : '';
            const icon  = satisfied ? '‚úÖ' : inProgress ? 'üîÑ' : '‚óã';
            const label = satisfied ? 'Satisfied' : inProgress ? 'In Progress' : 'Not Yet Earned';
            return `<div class="choice-group ${cls}">
              <div class="choice-group-header">
                <span>${icon}</span>
                <span>${esc(group.label)}</span>
                <span class="pill ${satisfied ? 'pill-green' : inProgress ? 'pill-gold' : 'pill-gray'}" style="margin-left:auto">${label}</span>
              </div>
              <div class="choice-group-options">
                ${gMBs.map(mb => {
                  const prog = eagleProgMap[mb.name];
                  const progStr = (prog && prog.total > 0) ? `<span style="font-size:0.65rem;opacity:0.75;margin-left:4px">${prog.done}/${prog.total}</span>` : '';
                  return `<div class="eagle-item ${mb.status === 'completed' ? 'earned' : mb.status === 'in_progress' ? 'progress' : 'needed'}" style="flex:1;min-width:120px;cursor:pointer" onclick="showMBDetail(${esc(JSON.stringify(mb.name))})">
                    <span class="ei-icon">${mb.status === 'completed' ? '‚úÖ' : mb.status === 'in_progress' ? 'üîÑ' : '‚óã'}</span>
                    <span>${esc(mb.name)}${mb.date_completed && mb.status === 'completed' ? `<br><span style="font-size:0.65rem;opacity:0.7">${fmtDate(mb.date_completed)}</span>` : progStr ? `<br>${progStr}` : ''}</span>
                  </div>`;
                }).join('')}
              </div>
            </div>`;
          }).join('')}
        </div>
      </div>

      <!-- Next Rank Requirements -->
      <div class="panel">
        <div class="panel-header">
          <span class="panel-icon">üìã</span>
          <h2>${nextName ? 'Requirements for ' + esc(nextName) : 'Next Rank Requirements'}</h2>
          ${nextTotal > 0
            ? `<span class="pill ${nextPct === 100 ? 'pill-green' : 'pill-blue'}" style="margin-left:auto">${nextDone}/${nextTotal}</span>`
            : ''}
        </div>
        <div class="panel-body">
          ${nextReqs.length > 0
            ? `<ul class="req-list">${nextReqs.map(r => `
                <li class="req-item">
                  <div class="req-circle ${r.completed ? 'done' : 'todo'}">${r.completed ? '‚úì' : ''}</div>
                  <div style="flex:1;min-width:0">
                    <div style="display:flex;gap:6px;align-items:baseline;flex-wrap:wrap">
                      ${r.requirement_number ? `<span class="req-num">${esc(r.requirement_number)}</span>` : ''}
                      <span>${esc(r.desc || r.full_name || '')}</span>
                    </div>
                    ${r.completed && r.date_completed ? `<div class="req-date">‚úì ${fmtDate(r.date_completed)}</div>` : ''}
                  </div>
                </li>`).join('')}</ul>`
            : `<div class="no-data">No requirement data ‚Äî run <code>scouting sync-scouts</code> to populate</div>`}
        </div>
      </div>

      <!-- Merit Badge List -->
      <div class="panel panel-full">
        <div class="panel-header">
          <span class="panel-icon">üéñÔ∏è</span>
          <h2>Merit Badges</h2>
          <div style="margin-left:auto;display:flex;gap:6px">
            <span class="pill pill-green">${earnedMBs.length} earned</span>
            <span class="pill pill-gold">${inProgMBs.length} in progress</span>
          </div>
        </div>
        <div class="panel-body">
          <div class="mini-tabs">
            <button class="mini-tab active" onclick="filterMBTab('all',this)">All (${allMBs.length})</button>
            <button class="mini-tab" onclick="filterMBTab('completed',this)">Earned (${earnedMBs.length})</button>
            <button class="mini-tab" onclick="filterMBTab('in_progress',this)">In Progress (${inProgMBs.length})</button>
          </div>
          ${allMBs.length > 0
            ? `<div class="tbl-wrap">
                <table class="sortable">
                  <thead><tr><th>Merit Badge</th><th>Status</th><th class="hide-sm">Started</th><th class="hide-sm">Completed</th><th></th></tr></thead>
                  <tbody id="mb-tbody">
                    ${allMBs.map(mb => `
                      <tr data-status="${mb.status}" class="clickable-row" onclick="showMBDetail(${esc(JSON.stringify(mb.merit_badge_name))})">
                        <td><span class="mb-name-link">${esc(mb.merit_badge_name)}</span></td>
                        <td><span class="pill ${mb.status === 'completed' ? 'pill-green' : 'pill-gold'}">${mb.status === 'completed' ? 'Earned' : 'In Progress'}</span></td>
                        <td class="hide-sm">${mb.date_started ? fmtDate(mb.date_started) : '‚Äî'}</td>
                        <td class="hide-sm">${mb.date_completed ? fmtDate(mb.date_completed) : '‚Äî'}</td>
                        <td style="color:var(--muted);font-size:0.8rem">‚Ä∫</td>
                      </tr>`).join('')}
                  </tbody>
                </table>
              </div>`
            : `<div class="no-data">No merit badge data ‚Äî run <code>scouting sync-scouts</code></div>`}
        </div>
      </div>

      <!-- Leadership -->
      <div class="panel">
        <div class="panel-header">
          <span class="panel-icon">ü¶Ö</span>
          <h2>Leadership Positions</h2>
          <span class="pill pill-blue" style="margin-left:auto">${leadership.length}</span>
        </div>
        <div class="panel-body no-pad">
          ${leadership.length > 0
            ? `<div class="tbl-wrap">
                <table class="sortable">
                  <thead><tr><th>Position</th><th>Start</th><th>End</th><th>Days</th><th>Status</th></tr></thead>
                  <tbody>
                    ${leadership.map(l => `
                      <tr>
                        <td><strong>${esc(l.position)}</strong>${l.patrol ? `<br><span style="font-size:0.7rem;color:var(--muted)">${esc(l.patrol)}</span>` : ''}</td>
                        <td>${fmtDate(l.start_date)}</td>
                        <td>${l.end_date ? fmtDate(l.end_date) : '<span class="pill pill-green">Active</span>'}</td>
                        <td>${l.days_in_position || '‚Äî'}</td>
                        <td><span class="pill ${l.approved ? 'pill-green' : 'pill-gray'}">${l.approved ? 'Approved' : 'Pending'}</span></td>
                      </tr>`).join('')}
                  </tbody>
                </table>
              </div>`
            : `<div class="no-data">No leadership positions recorded</div>`}
        </div>
      </div>

      <!-- Rank History -->
      <div class="panel">
        <div class="panel-header">
          <span class="panel-icon">üìÖ</span>
          <h2>Rank History</h2>
        </div>
        <div class="panel-body no-pad">
          ${rankHistory.length > 0
            ? `<div class="tbl-wrap">
                <table class="sortable">
                  <thead><tr><th>Rank</th><th>Status</th><th>Date Earned</th></tr></thead>
                  <tbody>
                    ${rankHistory.map(r => `
                      <tr>
                        <td>${esc(r.advancement_name)}</td>
                        <td><span class="pill ${r.status === 'completed' ? 'pill-green' : 'pill-gold'}">${r.status}</span></td>
                        <td>${r.date_completed ? fmtDate(r.date_completed) : '‚Äî'}</td>
                      </tr>`).join('')}
                  </tbody>
                </table>
              </div>`
            : `<div class="no-data">No rank history ‚Äî run <code>scouting sync-scouts</code></div>`}
        </div>
      </div>

    </div><!-- /panels-grid -->
  `;
  relayoutPanels(document.getElementById('scout-content'));
}

function filterMBTab(status, btn) {
  document.querySelectorAll('.mini-tab').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  const rows = document.querySelectorAll('#mb-tbody tr');
  rows.forEach(row => {
    row.style.display = (status === 'all' || row.dataset.status === status) ? '' : 'none';
  });
}

// ‚îÄ‚îÄ‚îÄ Troop View ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loadTroopView() {
  const n = (q1('SELECT COUNT(*) AS n FROM scouts') || {n: 0}).n;
  if (n === 0) {
    document.getElementById('troop-content').innerHTML =
      '<div class="empty-state"><div class="ei">‚öúÔ∏è</div><p>No Scouts found in the database.</p></div>';
    return;
  }

  const eagleTracked = EAGLE_SLOT_COUNT; // 14 slots: 11 mandatory + 3 choice groups
  const totalMBs     = (q1('SELECT COUNT(*) AS n FROM scout_merit_badges WHERE status="completed"') || {n: 0}).n;
  const inProgMBs    = (q1('SELECT COUNT(*) AS n FROM scout_merit_badges WHERE status="in_progress"') || {n: 0}).n;

  const rankDist = q(`
    SELECT r.name AS rank_name, r.level, COUNT(s.user_id) AS scout_count
    FROM ranks r LEFT JOIN scouts s ON s.current_rank_id = r.id
    WHERE r.program_id = 2
    GROUP BY r.id ORDER BY r.level`);

  const eagleGaps = q(`
    SELECT mb.name, COUNT(s.user_id) AS scouts_needing,
      ROUND(COUNT(s.user_id)*100.0/MAX(?,1),1) AS pct_needing,
      SUM(CASE WHEN smb_p.status='in_progress' THEN 1 ELSE 0 END) AS in_progress_count
    FROM merit_badges mb
    CROSS JOIN scouts s
    LEFT JOIN scout_merit_badges smb
      ON smb.scout_user_id=s.user_id AND smb.merit_badge_name=mb.name AND smb.status='completed'
    LEFT JOIN scout_merit_badges smb_p
      ON smb_p.scout_user_id=s.user_id AND smb_p.merit_badge_name=mb.name AND smb_p.status='in_progress'
    WHERE smb.id IS NULL AND mb.is_eagle_required=1 AND mb.active=1
    GROUP BY mb.name ORDER BY scouts_needing DESC`, [n]);

  const allMBGaps = q(`
    SELECT mb.name, mb.is_eagle_required, COUNT(s.user_id) AS scouts_needing,
      ROUND(COUNT(s.user_id)*100.0/MAX(?,1),1) AS pct_needing,
      (SELECT COUNT(*) FROM scout_merit_badges WHERE merit_badge_name=mb.name AND status='in_progress') AS scouts_in_progress,
      (SELECT COUNT(*) FROM scout_merit_badges WHERE merit_badge_name=mb.name AND status='completed') AS scouts_completed
    FROM merit_badges mb
    CROSS JOIN scouts s
    LEFT JOIN scout_merit_badges smb
      ON smb.scout_user_id=s.user_id AND smb.merit_badge_name=mb.name AND smb.status='completed'
    WHERE smb.id IS NULL AND mb.active=1
    GROUP BY mb.name ORDER BY scouts_needing DESC LIMIT 20`, [n]);

  const closestToRank = q(`
    WITH nr AS (
      SELECT s.user_id,
        TRIM(COALESCE(s.first_name,'')||' '||COALESCE(s.last_name,'')) AS scout_name,
        cr.name AS current_rank, COALESCE(cr.level,0) AS cur_lv,
        nxt.id AS next_id, nxt.name AS next_rank_name
      FROM scouts s
      LEFT JOIN ranks cr ON cr.id=s.current_rank_id
      INNER JOIN ranks nxt ON nxt.program_id=2 AND nxt.level=COALESCE(cr.level,0)+1
    ),
    rc AS (
      SELECT nr.user_id, nr.scout_name, nr.current_rank, nr.next_rank_name,
        COUNT(r.id) AS total_req,
        COALESCE(SUM(CASE WHEN src.completed=1 THEN 1 ELSE 0 END),0) AS done_req
      FROM nr
      INNER JOIN requirements r ON r.rank_id=nr.next_id AND r.required=1 AND r.parent_requirement_id IS NULL
      LEFT JOIN scout_requirement_completions src ON src.scout_user_id=nr.user_id AND src.requirement_id=r.id
      GROUP BY nr.user_id
    )
    SELECT user_id, scout_name, current_rank, next_rank_name, total_req, done_req,
      total_req-done_req AS remaining,
      ROUND(done_req*100.0/MAX(total_req,1),1) AS pct_complete
    FROM rc WHERE total_req > 0
    ORDER BY pct_complete DESC, remaining ASC LIMIT 20`);

  const activityPlanner = q(`
    SELECT mb.name AS activity_name, mb.is_eagle_required,
      COUNT(s.user_id) AS scouts_benefiting,
      ROUND(COUNT(s.user_id)*100.0/MAX(?,1),1) AS pct_benefiting
    FROM merit_badges mb
    CROSS JOIN scouts s
    LEFT JOIN scout_merit_badges smb
      ON smb.scout_user_id=s.user_id AND smb.merit_badge_name=mb.name AND smb.status='completed'
    WHERE smb.id IS NULL AND mb.active=1
    GROUP BY mb.name HAVING pct_benefiting >= 40
    ORDER BY mb.is_eagle_required DESC, pct_benefiting DESC LIMIT 20`, [n]);

  const rosterPatrolSel = hasPatrolCol ? 'COALESCE(s.patrol,NULL) AS patrol,' : 'NULL AS patrol,';
  const roster = q(`
    SELECT TRIM(COALESCE(s.first_name,'')||' '||COALESCE(s.last_name,'')) AS scout_name,
      s.user_id, ${rosterPatrolSel}
      COALESCE(r.name,'New Scout') AS current_rank, COALESCE(r.level,0) AS rank_level,
      (SELECT COUNT(*) FROM scout_merit_badges smb WHERE smb.scout_user_id=s.user_id AND smb.status='completed') AS total_mbs,
      (SELECT COUNT(*) FROM scout_merit_badges smb
         JOIN merit_badges mb ON mb.name=smb.merit_badge_name
         WHERE smb.scout_user_id=s.user_id AND smb.status='completed' AND mb.is_eagle_required=1) AS eagle_mbs,
      (SELECT COUNT(*) FROM scout_merit_badges smb WHERE smb.scout_user_id=s.user_id AND smb.status='in_progress') AS in_prog,
      (SELECT COUNT(*) FROM scout_leadership sl WHERE sl.scout_user_id=s.user_id AND sl.approved=1) AS approved_positions
    FROM scouts s LEFT JOIN ranks r ON r.id=s.current_rank_id
    ORDER BY COALESCE(r.level,0) DESC, scout_name`);

  // Per-scout Eagle slot counts (for pipeline stats and roster)
  const eagleSlotData = q(`
    SELECT s.user_id,
      (SELECT COUNT(*) FROM scout_merit_badges smb WHERE smb.scout_user_id=s.user_id AND smb.status='completed'
         AND smb.merit_badge_name IN ('Camping','Citizenship in the Community','Citizenship in the Nation',
           'Citizenship in Society','Citizenship in the World','Communication','Cooking',
           'Family Life','First Aid','Personal Fitness','Personal Management')) AS mandatory_done,
      CASE WHEN (SELECT COUNT(*) FROM scout_merit_badges smb WHERE smb.scout_user_id=s.user_id AND smb.status='completed'
           AND smb.merit_badge_name IN ('Emergency Preparedness','Lifesaving')) >= 1 THEN 1 ELSE 0 END AS group_a,
      CASE WHEN (SELECT COUNT(*) FROM scout_merit_badges smb WHERE smb.scout_user_id=s.user_id AND smb.status='completed'
           AND smb.merit_badge_name IN ('Environmental Science','Sustainability')) >= 1 THEN 1 ELSE 0 END AS group_b,
      CASE WHEN (SELECT COUNT(*) FROM scout_merit_badges smb WHERE smb.scout_user_id=s.user_id AND smb.status='completed'
           AND smb.merit_badge_name IN ('Swimming','Hiking','Cycling')) >= 1 THEN 1 ELSE 0 END AS group_c
    FROM scouts s`);

  const slotByUser = {};
  eagleSlotData.forEach(r => { slotByUser[r.user_id] = r.mandatory_done + r.group_a + r.group_b + r.group_c; });

  // Troop-level choice group satisfaction stats
  const choiceGroupTroopStats = EAGLE_CHOICE_GROUPS.map((group, i) => {
    const key = ['group_a', 'group_b', 'group_c'][i];
    const satisfied = eagleSlotData.filter(r => r[key] === 1).length;
    const perBadge = group.badges.map(badge => {
      const cnt  = (q1(`SELECT COUNT(*) AS n FROM scout_merit_badges WHERE merit_badge_name=? AND status='completed'`, [badge]) || {n:0}).n;
      const prog = (q1(`SELECT COUNT(*) AS n FROM scout_merit_badges WHERE merit_badge_name=? AND status='in_progress'`, [badge]) || {n:0}).n;
      return { badge, cnt, prog };
    });
    return { label: group.label, satisfied, notSatisfied: n - satisfied,
             pctSatisfied: n > 0 ? Math.round(satisfied * 100 / n) : 0, perBadge };
  });

  // Lookup: badge name ‚Üí choice group index (0/1/2), for all choice-group badges
  const choiceBadgeGroupIdx = {};
  EAGLE_CHOICE_GROUPS.forEach((g, i) => g.badges.forEach(b => { choiceBadgeGroupIdx[b] = i; }));

  // Scouts who have NOT yet satisfied each choice group
  const groupUnsatisfied = [
    eagleSlotData.filter(r => r.group_a === 0).length,
    eagleSlotData.filter(r => r.group_b === 0).length,
    eagleSlotData.filter(r => r.group_c === 0).length,
  ];

  // Activity planner: for choice-group badges replace the raw "doesn't have badge X"
  // count with the true "group slot not yet filled" count, then re-filter and re-sort.
  const activityPlannerAdj = activityPlanner
    .map(a => {
      const gi = choiceBadgeGroupIdx[a.activity_name];
      if (gi !== undefined) {
        const trueBenefiting = groupUnsatisfied[gi];
        return { ...a, scouts_benefiting: trueBenefiting,
                 pct_benefiting: Math.round(trueBenefiting * 100 / Math.max(n, 1)) };
      }
      return a;
    })
    .filter(a => a.pct_benefiting >= 40)
    .sort((a, b) => b.is_eagle_required - a.is_eagle_required || b.pct_benefiting - a.pct_benefiting)
    // Deduplicate choice groups: keep only the badge with the highest pct within each group
    .filter((a, _, arr) => {
      const gi = choiceBadgeGroupIdx[a.activity_name];
      if (gi === undefined) return true;
      const best = arr.find(x => choiceBadgeGroupIdx[x.activity_name] === gi);
      return best === a;
    });

  // Stat card: top Eagle gap should be a mandatory badge, not a choice-group alternative
  const topEagle    = eagleGaps.find(r => !(r.name in choiceBadgeGroupIdx));
  const closeToRank = closestToRank.filter(r => r.pct_complete >= 50).length;
  const avgMBs      = n > 0 ? (totalMBs / n).toFixed(1) : 0;
  const eagleReady  = eagleSlotData.filter(r => r.mandatory_done === 11 && r.group_a === 1 && r.group_b === 1 && r.group_c === 1).length;
  const avgSlots    = n > 0 ? (eagleSlotData.reduce((s,r) => s + r.mandatory_done + r.group_a + r.group_b + r.group_c, 0) / n).toFixed(1) : 0;

  document.getElementById('troop-content').innerHTML = `

    <!-- Summary Stat Cards -->
    <div class="stats-grid" style="margin-bottom:20px">
      <div class="stat-card">
        <div class="stat-label">Total Scouts</div>
        <div class="stat-value">${n}</div>
        <div class="stat-sub">${rankDist.filter(r => r.scout_count > 0).length} active rank levels</div>
      </div>
      <div class="stat-card green">
        <div class="stat-label">Merit Badges Earned</div>
        <div class="stat-value">${totalMBs}</div>
        <div class="stat-sub">avg ${avgMBs} per Scout ¬∑ ${inProgMBs} in progress</div>
      </div>
      <div class="stat-card gold">
        <div class="stat-label">Top Eagle MB Gap</div>
        <div class="stat-value" style="font-size:0.95rem;line-height:1.3">${topEagle ? `<a class="mb-name-link" style="color:inherit" onclick="showTroopMBDetail(${esc(JSON.stringify(topEagle.name))})">${esc(topEagle.name)}</a>` : '‚Äî'}</div>
        <div class="stat-sub">${topEagle ? topEagle.scouts_needing + ' Scouts (' + topEagle.pct_needing + '%) need it' : 'No gap data'}</div>
      </div>
      <div class="stat-card purple">
        <div class="stat-label">Close to Rank-Up</div>
        <div class="stat-value">${closeToRank}</div>
        <div class="stat-sub">Scouts ‚â• 50% complete on next rank</div>
      </div>
    </div>

    <div class="panels-grid">

      <!-- Rank Distribution -->
      <div class="panel">
        <div class="panel-header"><span class="panel-icon">üìä</span><h2>Rank Distribution</h2></div>
        <div class="panel-body no-pad">
          <div class="tbl-wrap">
            <table class="sortable">
              <thead><tr><th>Rank</th><th style="text-align:right">Scouts</th><th class="hide-sm">Share of Troop</th></tr></thead>
              <tbody>
                ${rankDist.map(r => {
                  const pct = n > 0 ? Math.round(r.scout_count * 100 / n) : 0;
                  return `<tr ${r.scout_count > 0 ? 'class="bold-row"' : 'style="opacity:0.5"'}>
                    <td>${esc(r.rank_name)}</td>
                    <td style="text-align:right"><strong>${r.scout_count}</strong></td>
                    <td class="bar-cell">
                      <div class="bar-wrap">
                        <div class="mini-bar"><div class="mini-fill" style="width:${pct}%"></div></div>
                        <span class="bar-pct">${pct}%</span>
                      </div>
                    </td>
                  </tr>`;
                }).join('')}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Eagle MB Gap Analysis -->
      <div class="panel">
        <div class="panel-header">
          <span class="panel-icon">‚≠ê</span>
          <h2>Eagle MB Gaps</h2>
        </div>
        <div class="panel-body no-pad">
          <!-- Required badges section -->
          <div style="padding:10px 14px 4px;font-size:0.68rem;text-transform:uppercase;letter-spacing:0.08em;color:var(--muted);font-weight:700;background:#fafafa;border-bottom:1px solid var(--border)">Required ‚Äî 11 mandatory badges</div>
          <div class="tbl-wrap">
            <table>
              <thead><tr><th>Merit Badge</th><th style="text-align:right">Need</th><th class="hide-sm">% of Troop</th><th>In Prog</th></tr></thead>
              <tbody>
                ${[...EAGLE_MANDATORY].sort((a, b) => a.localeCompare(b)).map(name => {
                  const row = eagleGaps.find(r => r.name === name);
                  const need = row ? row.scouts_needing : 0;
                  const pct  = row ? row.pct_needing : 0;
                  const prog = row ? (row.in_progress_count || 0) : 0;
                  return `<tr ${need === 0 ? 'style="opacity:0.45"' : ''}>
                    <td><a class="mb-name-link" onclick="showTroopMBDetail(${esc(JSON.stringify(name))})">${esc(name)}</a></td>
                    <td style="text-align:right"><strong>${need}</strong></td>
                    <td class="bar-cell">
                      <div class="bar-wrap">
                        <div class="mini-bar"><div class="mini-fill gold" style="width:${pct}%"></div></div>
                        <span class="bar-pct">${pct}%</span>
                      </div>
                    </td>
                    <td>${prog > 0 ? `<span class="pill pill-gold">${prog}</span>` : '<span style="color:var(--muted)">‚Äî</span>'}</td>
                  </tr>`;
                }).join('')}
              </tbody>
            </table>
          </div>
          <!-- Choice groups section -->
          <div style="padding:10px 14px 4px;font-size:0.68rem;text-transform:uppercase;letter-spacing:0.08em;color:var(--muted);font-weight:700;background:#fafafa;border-top:2px solid var(--border);border-bottom:1px solid var(--border)">Choose One from Each Group ‚Äî 3 slots</div>
          <div class="tbl-wrap">
            <table>
              <tbody>
                ${choiceGroupTroopStats.map(cg => `
                  <tr><td colspan="4" style="padding:6px 12px 4px;font-size:0.72rem;font-weight:700;text-transform:uppercase;letter-spacing:0.06em;color:var(--muted);background:#fafafa;border-top:1px solid var(--border)">${esc(cg.label)} ‚Äî ${cg.notSatisfied} scout${cg.notSatisfied !== 1 ? 's' : ''} unsatisfied</td></tr>
                  ${[...cg.perBadge].sort((a, b) => a.badge.localeCompare(b.badge)).map(pb => {
                    const need = n - pb.cnt;
                    const pct  = n > 0 ? Math.round(need * 100 / n) : 0;
                    const prog = pb.prog || 0;
                    return `<tr ${need === 0 ? 'style="opacity:0.45"' : ''}>
                      <td><a class="mb-name-link" onclick="showTroopMBDetail(${esc(JSON.stringify(pb.badge))})">${esc(pb.badge)}</a></td>
                      <td style="text-align:right"><strong>${need}</strong></td>
                      <td class="bar-cell">
                        <div class="bar-wrap">
                          <div class="mini-bar"><div class="mini-fill gold" style="width:${pct}%"></div></div>
                          <span class="bar-pct">${pct}%</span>
                        </div>
                      </td>
                      <td>${prog > 0 ? `<span class="pill pill-gold">${prog}</span>` : '<span style="color:var(--muted)">‚Äî</span>'}</td>
                    </tr>`;
                  }).join('')}`).join('')}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Scouts Closest to Next Rank -->
      <div class="panel">
        <div class="panel-header">
          <span class="panel-icon">üéØ</span>
          <h2>Closest to Rank Advancement</h2>
          <span class="panel-sub" style="font-size:0.72rem;color:var(--muted);margin-left:auto">fewest reqs remaining</span>
        </div>
        <div class="panel-body no-pad">
          ${closestToRank.length > 0
            ? `<div class="tbl-wrap">
                <table class="sortable">
                  <thead><tr><th>Scout</th><th>Working Toward</th><th class="hide-sm">Progress</th><th>Left</th></tr></thead>
                  <tbody>
                    ${closestToRank.map(r => `
                      <tr>
                        <td><a class="scout-link" onclick="goToScout(${r.user_id})">${esc(r.scout_name)}</a></td>
                        <td>
                          ${esc(r.next_rank_name)}
                          <div style="font-size:0.68rem;color:var(--muted)">${r.done_req}/${r.total_req} reqs</div>
                        </td>
                        <td class="bar-cell">
                          <div class="bar-wrap">
                            <div class="mini-bar">
                              <div class="mini-fill ${r.pct_complete >= 80 ? 'green' : ''}" style="width:${r.pct_complete}%"></div>
                            </div>
                            <span class="bar-pct">${r.pct_complete}%</span>
                          </div>
                        </td>
                        <td><span class="pill ${r.remaining === 0 ? 'pill-green' : r.remaining <= 2 ? 'pill-gold' : 'pill-gray'}">${r.remaining}</span></td>
                      </tr>`).join('')}
                  </tbody>
                </table>
              </div>`
            : `<div class="no-data">No rank requirement data ‚Äî run <code>scouting sync-scouts</code></div>`}
        </div>
      </div>

      <!-- Group Activity Planner -->
      <div class="panel">
        <div class="panel-header">
          <span class="panel-icon">üìÖ</span>
          <h2>Group Activity Planner</h2>
          <span class="panel-sub" style="font-size:0.72rem;color:var(--muted);margin-left:auto">‚òÖ = Eagle-required ¬∑ ‚â• 40% of troop benefits</span>
        </div>
        <div class="panel-body no-pad">
          ${activityPlannerAdj.length > 0
            ? `<div class="tbl-wrap">
                <table class="sortable">
                  <thead><tr><th>Merit Badge Activity</th><th style="text-align:right">Scouts Benefit</th><th class="hide-sm">Troop %</th></tr></thead>
                  <tbody>
                    ${activityPlannerAdj.map(a => `
                      <tr>
                        <td>
                          <a class="mb-name-link" onclick="showTroopMBDetail(${esc(JSON.stringify(a.activity_name))})">${esc(a.activity_name)}</a>
                          ${a.is_eagle_required ? '<span class="star-marker"> ‚òÖ</span>' : ''}
                        </td>
                        <td style="text-align:right">${a.scouts_benefiting}</td>
                        <td class="bar-cell">
                          <div class="bar-wrap">
                            <div class="mini-bar">
                              <div class="mini-fill ${a.is_eagle_required ? 'gold' : ''}" style="width:${a.pct_benefiting}%"></div>
                            </div>
                            <span class="bar-pct">${a.pct_benefiting}%</span>
                          </div>
                        </td>
                      </tr>`).join('')}
                  </tbody>
                </table>
              </div>`
            : `<div class="no-data">No activities meet the 40% threshold ‚Äî try running <code>scouting query plan --min-pct 30</code></div>`}
        </div>
      </div>

      <!-- Most Needed Any MB (top 20) -->
      <div class="panel">
        <div class="panel-header">
          <span class="panel-icon">üìå</span>
          <h2>Most Needed Merit Badges</h2>
          <span class="panel-sub" style="font-size:0.72rem;color:var(--muted);margin-left:auto">all badges, not just Eagle-required</span>
        </div>
        <div class="panel-body no-pad">
          <div class="tbl-wrap">
            <table class="sortable">
              <thead><tr><th>Merit Badge</th><th>Eagle</th><th style="text-align:right">Scouts Need</th><th style="text-align:right" class="hide-sm">In Progress</th><th style="text-align:right" class="hide-sm">Completed</th><th class="hide-sm">%</th></tr></thead>
              <tbody>
                ${allMBGaps.map(mb => `
                  <tr>
                    <td><a class="mb-name-link" onclick="showTroopMBDetail(${esc(JSON.stringify(mb.name))})">${esc(mb.name)}</a></td>
                    <td>${mb.is_eagle_required ? '<span class="star-marker">‚òÖ</span>' : ''}</td>
                    <td style="text-align:right">${mb.scouts_needing}</td>
                    <td style="text-align:right" class="hide-sm">${mb.scouts_in_progress || 0}</td>
                    <td style="text-align:right" class="hide-sm">${mb.scouts_completed || 0}</td>
                    <td class="bar-cell">
                      <div class="bar-wrap">
                        <div class="mini-bar">
                          <div class="mini-fill ${mb.is_eagle_required ? 'gold' : ''}" style="width:${mb.pct_needing}%"></div>
                        </div>
                        <span class="bar-pct">${mb.pct_needing}%</span>
                      </div>
                    </td>
                  </tr>`).join('')}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Eagle Pipeline Summary -->
      <div class="panel">
        <div class="panel-header"><span class="panel-icon">ü¶Ö</span><h2>Eagle Pipeline</h2></div>
        <div class="panel-body">
          ${[
            { label: 'Total Scouts in troop',                          value: n,           color: '',       key: 'all' },
            { label: 'At Tenderfoot rank',                             value: roster.filter(r => r.rank_level === 2).length, color: 'blue',   key: 'tenderfoot' },
            { label: 'At First Class rank',                            value: roster.filter(r => r.rank_level === 4).length, color: 'blue',   key: 'first_class' },
            { label: 'At Star rank',                                   value: roster.filter(r => r.rank_level === 5).length, color: 'purple', key: 'star' },
            { label: 'At Life rank',                                   value: roster.filter(r => r.rank_level === 6).length, color: 'gold',   key: 'life' },
            { label: 'All 14 Eagle slots filled (MB requirement met)', value: eagleReady,  color: 'green',  key: 'eagle_ready' },
            { label: 'Avg Eagle slots filled per Scout',               value: avgSlots,    color: '' },
          ].map(row => `
            <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border)">
              <span style="font-size:0.82rem">${row.key
                ? `<a class="scout-link" onclick="showPipelineModal('${row.key}')">${row.label}</a>`
                : row.label}</span>
              <strong style="color:var(--${row.color || 'muted'});font-size:1rem">${row.value}</strong>
            </div>`).join('')}
        </div>
      </div>

    </div><!-- /panels-grid -->
  `;
  relayoutPanels(document.getElementById('troop-content'));
}

// ‚îÄ‚îÄ‚îÄ Roster View ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loadRosterView() {
  const el = document.getElementById('roster-content');
  if (!db) return;
  const n = (q1('SELECT COUNT(*) AS n FROM scouts') || {n: 0}).n;
  if (n === 0) {
    el.innerHTML = '<div class="empty-state"><div class="ei">‚öúÔ∏è</div><p>No Scouts found in the database.</p></div>';
    return;
  }

  const rosterPatrolSel = hasPatrolCol ? 'COALESCE(s.patrol,NULL) AS patrol,' : 'NULL AS patrol,';
  const roster = q(`
    SELECT TRIM(COALESCE(s.first_name,'')||' '||COALESCE(s.last_name,'')) AS scout_name,
      s.user_id, ${rosterPatrolSel}
      COALESCE(r.name,'New Scout') AS current_rank, COALESCE(r.level,0) AS rank_level,
      (SELECT COUNT(*) FROM scout_merit_badges smb WHERE smb.scout_user_id=s.user_id AND smb.status='completed') AS total_mbs,
      (SELECT COUNT(*) FROM scout_merit_badges smb
         JOIN merit_badges mb ON mb.name=smb.merit_badge_name
         WHERE smb.scout_user_id=s.user_id AND smb.status='completed' AND mb.is_eagle_required=1) AS eagle_mbs,
      (SELECT COUNT(*) FROM scout_merit_badges smb WHERE smb.scout_user_id=s.user_id AND smb.status='in_progress') AS in_prog,
      (SELECT COUNT(*) FROM scout_leadership sl WHERE sl.scout_user_id=s.user_id AND sl.approved=1) AS approved_positions
    FROM scouts s LEFT JOIN ranks r ON r.id=s.current_rank_id
    ORDER BY COALESCE(r.level,0) DESC, scout_name`);

  const eagleSlotData = q(`
    SELECT s.user_id,
      (SELECT COUNT(*) FROM scout_merit_badges smb WHERE smb.scout_user_id=s.user_id AND smb.status='completed'
         AND smb.merit_badge_name IN ('Camping','Citizenship in the Community','Citizenship in the Nation',
           'Citizenship in Society','Citizenship in the World','Communication','Cooking',
           'Family Life','First Aid','Personal Fitness','Personal Management')) AS mandatory_done,
      CASE WHEN (SELECT COUNT(*) FROM scout_merit_badges smb WHERE smb.scout_user_id=s.user_id AND smb.status='completed'
           AND smb.merit_badge_name IN ('Emergency Preparedness','Lifesaving')) >= 1 THEN 1 ELSE 0 END AS group_a,
      CASE WHEN (SELECT COUNT(*) FROM scout_merit_badges smb WHERE smb.scout_user_id=s.user_id AND smb.status='completed'
           AND smb.merit_badge_name IN ('Environmental Science','Sustainability')) >= 1 THEN 1 ELSE 0 END AS group_b,
      CASE WHEN (SELECT COUNT(*) FROM scout_merit_badges smb WHERE smb.scout_user_id=s.user_id AND smb.status='completed'
           AND smb.merit_badge_name IN ('Swimming','Hiking','Cycling')) >= 1 THEN 1 ELSE 0 END AS group_c
    FROM scouts s`);

  const slotByUser = {};
  eagleSlotData.forEach(r => { slotByUser[r.user_id] = r.mandatory_done + r.group_a + r.group_b + r.group_c; });

  const patrolGroups = {};
  const unassignedScouts = [];
  if (hasPatrolCol) {
    roster.forEach(r => {
      const p = (r.patrol || '').trim();
      if (p && p.toLowerCase() !== 'unassigned') {
        if (!patrolGroups[p]) patrolGroups[p] = [];
        patrolGroups[p].push(r);
      } else {
        unassignedScouts.push(r);
      }
    });
  }
  const patrolNames = Object.keys(patrolGroups).sort((a, b) => a.localeCompare(b));
  const namedPatrolCount = patrolNames.length;

  const rosterRowHtml = r => {
    const slots = slotByUser[r.user_id] || 0;
    const epct  = Math.round(slots * 100 / EAGLE_SLOT_COUNT);
    return `<tr>
      <td><a class="scout-link" onclick="goToScout(${r.user_id})">${esc(r.scout_name)}</a></td>
      <td>${esc(r.current_rank)}</td>
      ${hasPatrolCol ? `<td>${r.patrol ? `<span class="pill pill-blue" style="font-size:0.72rem">‚öë ${esc(r.patrol)}</span>` : '<span style="color:var(--muted)">‚Äî</span>'}</td>` : ''}
      <td class="hide-sm" style="text-align:right">${r.total_mbs}</td>
      <td>${slots}<span style="color:var(--muted)"> / ${EAGLE_SLOT_COUNT}</span></td>
      <td class="bar-cell hide-sm">
        <div class="bar-wrap">
          <div class="mini-bar">
            <div class="mini-fill ${epct >= 100 ? 'green' : 'gold'}" style="width:${epct}%"></div>
          </div>
          <span class="bar-pct">${epct}%</span>
        </div>
      </td>
      <td style="text-align:right"><span class="pill pill-gold">${r.in_prog}</span></td>
      <td class="hide-sm" style="text-align:right">${r.approved_positions > 0 ? `<span class="pill pill-green">${r.approved_positions}</span>` : '<span class="pill pill-gray">0</span>'}</td>
    </tr>`;
  };

  const rosterThead = `<thead><tr>
    <th>Scout</th>
    <th>Current Rank</th>
    ${hasPatrolCol ? '<th>Patrol</th>' : ''}
    <th class="hide-sm" style="text-align:right">Total MBs</th>
    <th>Eagle Slots</th>
    <th class="hide-sm">Slot Progress</th>
    <th style="text-align:right">In Progress</th>
    <th class="hide-sm" style="text-align:right">Leadership</th>
  </tr></thead>`;

  el.innerHTML = `
    <div class="panels-grid">
      <div class="panel panel-full">
        <div class="panel-header">
          <span class="panel-icon">üìã</span>
          <h2>Troop Roster</h2>
          <span class="pill pill-blue" style="margin-left:auto">${roster.length} Scouts</span>
        </div>
        <div class="panel-body no-pad">
          <div class="tbl-wrap">
            <table class="sortable">
              ${rosterThead}
              <tbody>${roster.map(rosterRowHtml).join('')}</tbody>
            </table>
          </div>
        </div>
      </div>

      ${hasPatrolCol && (patrolNames.length > 0 || unassignedScouts.length > 0) ? `
      <div class="panel panel-full">
        <div class="panel-header">
          <span class="panel-icon">‚öë</span>
          <h2>Grouped by Patrol</h2>
          <span class="pill pill-blue" style="margin-left:auto">${namedPatrolCount} patrol${namedPatrolCount !== 1 ? 's' : ''}</span>
        </div>
        ${patrolNames.map(patrol => {
          const members = patrolGroups[patrol];
          return `
          <div style="border-bottom:1px solid var(--border)">
            <div style="padding:8px 14px;background:#fafafa;display:flex;align-items:center;gap:8px">
              <strong style="font-size:0.82rem">${esc(patrol)}</strong>
              <span class="pill pill-gray" style="font-size:0.68rem">${members.length}</span>
            </div>
            <div class="tbl-wrap">
              <table class="sortable">
                ${rosterThead}
                <tbody>${members.map(rosterRowHtml).join('')}</tbody>
              </table>
            </div>
          </div>`;
        }).join('')}
        ${unassignedScouts.length > 0 ? `
        <div style="border-bottom:1px solid var(--border)">
          <div style="padding:8px 14px;background:#fafafa;display:flex;align-items:center;gap:8px">
            <strong style="font-size:0.82rem;color:var(--muted)">Unassigned</strong>
            <span class="pill pill-gray" style="font-size:0.68rem">${unassignedScouts.length}</span>
          </div>
          <div class="tbl-wrap">
            <table class="sortable">
              ${rosterThead}
              <tbody>${unassignedScouts.map(rosterRowHtml).join('')}</tbody>
            </table>
          </div>
        </div>` : ''}
      </div>` : ''}

    </div><!-- /panels-grid -->
  `;
  relayoutPanels(el);
}

// ‚îÄ‚îÄ‚îÄ MB Detail Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function showMBDetail(mbName) {
  if (!db || !currentScoutId) return;

  // MB record for this scout (may be null if not started)
  const mbRow = q1(`
    SELECT merit_badge_name, status, date_completed, date_started,
      CAST(json_extract(raw_json, '$.id') AS INTEGER) AS api_id
    FROM scout_merit_badges
    WHERE scout_user_id = ? AND merit_badge_name = ?`, [currentScoutId, mbName]);

  // If this scout has no record, try to find the api_id from any scout (shared definitions)
  let apiId = mbRow ? mbRow.api_id : null;
  if (!apiId) {
    const anyRow = q1(`
      SELECT CAST(json_extract(raw_json, '$.id') AS INTEGER) AS api_id
      FROM scout_merit_badges
      WHERE merit_badge_name = ? AND raw_json IS NOT NULL
      LIMIT 1`, [mbName]);
    apiId = anyRow ? anyRow.api_id : null;
  }

  // Fetch requirements with per-scout completion status
  const reqs = apiId ? q(`
    SELECT mr.id, mr.requirement_number, mr.name AS req_name,
      mr.required, mr.parent_requirement_id, mr.children_required, mr.sort_order,
      COALESCE(smrc.completed, 0) AS completed, smrc.date_completed
    FROM mb_requirements mr
    LEFT JOIN scout_mb_requirement_completions smrc
      ON smrc.mb_requirement_id = mr.id AND smrc.scout_user_id = ?
    WHERE mr.mb_api_id = ?
    ORDER BY mr.sort_order, mr.requirement_number`, [currentScoutId, apiId]) : [];

  // ‚îÄ‚îÄ Populate modal header ‚îÄ‚îÄ
  document.getElementById('mb-modal-title').textContent = mbName;

  const status        = mbRow ? mbRow.status : null;
  const dateStarted   = mbRow ? mbRow.date_started : null;
  const dateCompleted = mbRow ? mbRow.date_completed : null;
  document.getElementById('mb-modal-status').innerHTML =
    status
      ? `<span class="pill ${status === 'completed' ? 'pill-green' : 'pill-gold'}">${status === 'completed' ? 'Earned' : 'In Progress'}</span>
         ${dateStarted   ? `<span style="color:var(--muted);font-size:0.79rem">Started ${fmtDate(dateStarted)}</span>` : ''}
         ${dateCompleted ? `<span style="color:var(--muted);font-size:0.79rem">Completed ${fmtDate(dateCompleted)}</span>` : ''}`
      : '<span class="pill pill-gray">Not started</span>';

  // ‚îÄ‚îÄ Progress bar ‚îÄ‚îÄ
  let progressHTML = '';
  if (reqs.length > 0) {
    const hasAnyDone = reqs.some(r => r.completed == 1);
    if (status === 'completed' && !hasAnyDone) {
      progressHTML = `<div style="padding:9px 20px;background:#f0fdf4;border-bottom:1px solid #bbf7d0;font-size:0.8rem;color:var(--green-light)">
        ‚úÖ Badge earned ‚Äî re-run <code>scouting sync-scouts</code> to populate per-requirement detail.
      </div>`;
    } else {
      const tree = buildReqTree(reqs);
      const roots = tree.filter(n => n.requirement_number || n.required == 1 || (n.children && n.children.length > 0));
      const doneCount = roots.filter(n => isNodeDone(n)).length;
      const pct = roots.length > 0 ? Math.round(doneCount * 100 / roots.length) : 0;
      progressHTML = `<div style="padding:9px 20px;border-bottom:1px solid var(--border);background:#fafafa">
        <div style="display:flex;align-items:center;gap:10px">
          <div style="flex:1"><div class="prog-bar" style="margin:0"><div class="prog-fill ${status === 'completed' ? 'green' : ''}" style="width:${pct}%"></div></div></div>
          <span style="font-size:0.8rem;color:var(--muted);white-space:nowrap">${doneCount} / ${roots.length} requirements done</span>
        </div>
      </div>`;
    }
  } else {
    progressHTML = `<div style="padding:9px 20px;background:#fefce8;border-bottom:1px solid #fde047;font-size:0.8rem;color:#713f12">
      ${apiId
        ? 'No per-requirement data found. Run <code>scouting sync-scouts</code> (without --skip-reqs) to sync it.'
        : 'Requirement definitions not available. These are fetched while syncing in-progress merit badges.'}
    </div>`;
  }
  document.getElementById('mb-modal-progress').innerHTML = progressHTML;

  // ‚îÄ‚îÄ Render requirement tree ‚îÄ‚îÄ
  const tree = buildReqTree(reqs);
  document.getElementById('mb-modal-body').innerHTML = tree.length > 0
    ? tree.map(n => renderReqNode(n, 0)).join('')
    : `<div class="no-data" style="padding:32px">No requirement details to display.</div>`;

  document.getElementById('mb-modal').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function closeMBModal() {
  document.getElementById('mb-modal').classList.remove('open');
  document.body.style.overflow = '';
}

// ‚îÄ‚îÄ‚îÄ Troop MB Participation Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function showTroopMBDetail(mbName) {
  if (!db) return;

  const mbInfo  = q1(`SELECT is_eagle_required FROM merit_badges WHERE name = ?`, [mbName]);
  const scouts  = q(`
    SELECT
      TRIM(COALESCE(s.first_name,'') || ' ' || COALESCE(s.last_name,'')) AS scout_name,
      s.user_id, smb.status, smb.date_started, smb.date_completed
    FROM scout_merit_badges smb
    JOIN scouts s ON s.user_id = smb.scout_user_id
    WHERE smb.merit_badge_name = ?
    ORDER BY
      CASE smb.status WHEN 'in_progress' THEN 0 WHEN 'completed' THEN 1 ELSE 2 END,
      s.last_name, s.first_name`, [mbName]);

  document.getElementById('troop-mb-modal-title').textContent = mbName;

  const completed = scouts.filter(s => s.status === 'completed').length;
  const inProg    = scouts.filter(s => s.status === 'in_progress').length;
  const eagleTag  = mbInfo && mbInfo.is_eagle_required
    ? ' ¬∑ <span class="star-marker">‚òÖ Eagle-required</span>' : '';
  document.getElementById('troop-mb-modal-sub').innerHTML =
    `${scouts.length} Scout${scouts.length !== 1 ? 's' : ''} participated ¬∑ ` +
    `<strong>${completed}</strong> completed ¬∑ <strong>${inProg}</strong> in progress${eagleTag}`;

  document.getElementById('troop-mb-modal-body').innerHTML = scouts.length === 0
    ? '<div class="no-data">No Scouts have started this merit badge.</div>'
    : `<table class="sortable" style="margin-top:4px">
        <thead><tr><th>Scout</th><th>Status</th><th>Started</th><th>Completed</th></tr></thead>
        <tbody>
          ${scouts.map(s => `
            <tr>
              <td><a class="scout-link" onclick="closeTroopMBModal();goToScout(${s.user_id})">${esc(s.scout_name)}</a></td>
              <td><span class="pill ${s.status === 'completed' ? 'pill-green' : 'pill-gold'}">${s.status === 'in_progress' ? 'In Progress' : 'Completed'}</span></td>
              <td>${s.date_started  ? fmtDate(s.date_started)  : '‚Äî'}</td>
              <td>${s.date_completed ? fmtDate(s.date_completed) : '‚Äî'}</td>
            </tr>`).join('')}
        </tbody>
      </table>`;

  document.getElementById('troop-mb-modal').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function closeTroopMBModal() {
  document.getElementById('troop-mb-modal').classList.remove('open');
  document.body.style.overflow = '';
}

// ‚îÄ‚îÄ‚îÄ Eagle Pipeline Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

const PIPELINE_LABELS = {
  all:         'All Scouts',
  tenderfoot:  'At Tenderfoot Rank',
  first_class: 'At First Class Rank',
  star:        'At Star Rank',
  life:        'At Life Rank',
  eagle_ready: 'Eagle MB Requirement Met (14 Slots Filled)',
};

function showPipelineModal(key) {
  if (!db) return;

  // Full scout stats including next-rank progress
  const pmPatrolSel = hasPatrolCol ? 's.patrol,' : 'NULL AS patrol,';
  const scouts = q(`
    WITH nr AS (
      SELECT s.user_id,
        TRIM(COALESCE(s.first_name,'')||' '||COALESCE(s.last_name,'')) AS scout_name,
        COALESCE(r.name,'New Scout') AS current_rank,
        COALESCE(r.level,0) AS rank_level,
        ${pmPatrolSel}
        nxt.id AS next_id, nxt.name AS next_rank_name
      FROM scouts s
      LEFT JOIN ranks r ON r.id=s.current_rank_id
      LEFT JOIN ranks nxt ON nxt.program_id=2 AND nxt.level=COALESCE(r.level,0)+1
    )
    SELECT nr.user_id, nr.scout_name, nr.current_rank, nr.rank_level,
      nr.patrol, nr.next_rank_name,
      COUNT(r.id) AS total_req,
      COALESCE(SUM(CASE WHEN src.completed=1 THEN 1 ELSE 0 END),0) AS done_req,
      (SELECT COUNT(*) FROM scout_merit_badges smb
         WHERE smb.scout_user_id=nr.user_id AND smb.status='completed') AS total_mbs,
      (SELECT COUNT(*) FROM scout_merit_badges smb
         WHERE smb.scout_user_id=nr.user_id AND smb.status='in_progress') AS in_prog,
      (SELECT COUNT(*) FROM scout_leadership sl
         WHERE sl.scout_user_id=nr.user_id AND sl.approved=1) AS leadership
    FROM nr
    LEFT JOIN requirements r ON r.rank_id=nr.next_id AND r.required=1 AND r.parent_requirement_id IS NULL
    LEFT JOIN scout_requirement_completions src ON src.scout_user_id=nr.user_id AND src.requirement_id=r.id
    GROUP BY nr.user_id
    ORDER BY nr.rank_level DESC, nr.scout_name`);

  // Eagle slot counts per scout
  const slotRows = q(`
    SELECT s.user_id,
      (SELECT COUNT(*) FROM scout_merit_badges smb WHERE smb.scout_user_id=s.user_id AND smb.status='completed'
         AND smb.merit_badge_name IN ('Camping','Citizenship in the Community','Citizenship in the Nation',
           'Citizenship in Society','Citizenship in the World','Communication','Cooking',
           'Family Life','First Aid','Personal Fitness','Personal Management')) AS mandatory_done,
      CASE WHEN (SELECT COUNT(*) FROM scout_merit_badges smb WHERE smb.scout_user_id=s.user_id AND smb.status='completed'
           AND smb.merit_badge_name IN ('Emergency Preparedness','Lifesaving')) >= 1 THEN 1 ELSE 0 END AS group_a,
      CASE WHEN (SELECT COUNT(*) FROM scout_merit_badges smb WHERE smb.scout_user_id=s.user_id AND smb.status='completed'
           AND smb.merit_badge_name IN ('Environmental Science','Sustainability')) >= 1 THEN 1 ELSE 0 END AS group_b,
      CASE WHEN (SELECT COUNT(*) FROM scout_merit_badges smb WHERE smb.scout_user_id=s.user_id AND smb.status='completed'
           AND smb.merit_badge_name IN ('Swimming','Hiking','Cycling')) >= 1 THEN 1 ELSE 0 END AS group_c
    FROM scouts s`);

  const slotByUser = {};
  slotRows.forEach(r => { slotByUser[r.user_id] = r.mandatory_done + r.group_a + r.group_b + r.group_c; });

  const filters = {
    all:         s => true,
    tenderfoot:  s => s.rank_level === 2,
    first_class: s => s.rank_level === 4,
    star:        s => s.rank_level === 5,
    life:        s => s.rank_level === 6,
    eagle_ready: s => (slotByUser[s.user_id] || 0) >= EAGLE_SLOT_COUNT,
  };

  const filtered = scouts.filter(filters[key] || (() => true));

  document.getElementById('pipeline-modal-title').textContent = PIPELINE_LABELS[key] || key;
  document.getElementById('pipeline-modal-sub').textContent =
    `${filtered.length} Scout${filtered.length !== 1 ? 's' : ''}`;

  document.getElementById('pipeline-modal-body').innerHTML = filtered.length === 0
    ? '<div class="no-data">No Scouts match this filter.</div>'
    : `<table class="sortable">
        <thead>
          <tr>
            <th>Scout</th><th>Current Rank</th>${hasPatrolCol ? '<th>Patrol</th>' : ''}<th>Next Rank</th>
            <th>Rank Progress</th><th>Eagle Slots</th>
            <th style="text-align:right">Total MBs</th>
            <th style="text-align:right">In Prog</th>
            <th style="text-align:right">Leadership</th>
          </tr>
        </thead>
        <tbody>
          ${filtered.map(s => {
            const slots = slotByUser[s.user_id] || 0;
            const epct  = Math.round(slots * 100 / EAGLE_SLOT_COUNT);
            const rpct  = s.total_req > 0 ? Math.round(s.done_req * 100 / s.total_req) : null;
            return `<tr>
              <td><a class="scout-link" onclick="closePipelineModal();goToScout(${s.user_id})">${esc(s.scout_name)}</a></td>
              <td>${esc(s.current_rank)}</td>
              ${hasPatrolCol ? `<td>${s.patrol ? `<span class="pill pill-blue" style="font-size:0.72rem">‚öë ${esc(s.patrol)}</span>` : '<span style="color:var(--muted)">‚Äî</span>'}</td>` : ''}
              <td>${s.next_rank_name ? esc(s.next_rank_name) : '<span style="color:var(--muted)">‚Äî</span>'}</td>
              <td>${rpct !== null
                ? `<div class="bar-wrap"><div class="mini-bar"><div class="mini-fill ${rpct >= 80 ? 'green' : ''}" style="width:${rpct}%"></div></div><span class="bar-pct">${s.done_req}/${s.total_req}</span></div>`
                : '<span style="color:var(--muted)">‚Äî</span>'}</td>
              <td>
                <div class="bar-wrap">
                  <div class="mini-bar"><div class="mini-fill ${epct >= 100 ? 'green' : 'gold'}" style="width:${epct}%"></div></div>
                  <span class="bar-pct">${slots}/${EAGLE_SLOT_COUNT}</span>
                </div>
              </td>
              <td style="text-align:right">${s.total_mbs}</td>
              <td style="text-align:right">${s.in_prog > 0 ? `<span class="pill pill-gold">${s.in_prog}</span>` : '<span style="color:var(--muted)">‚Äî</span>'}</td>
              <td style="text-align:right">${s.leadership > 0 ? `<span class="pill pill-green">${s.leadership}</span>` : '<span style="color:var(--muted)">‚Äî</span>'}</td>
            </tr>`;
          }).join('')}
        </tbody>
      </table>`;

  document.getElementById('pipeline-modal').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function closePipelineModal() {
  document.getElementById('pipeline-modal').classList.remove('open');
  document.body.style.overflow = '';
}

function buildReqTree(rows) {
  const byId = {};
  const roots = [];
  rows.forEach(r => { byId[r.id] = { ...r, children: [] }; });
  rows.forEach(r => {
    if (r.parent_requirement_id && byId[r.parent_requirement_id]) {
      byId[r.parent_requirement_id].children.push(byId[r.id]);
    } else if (!r.parent_requirement_id) {
      roots.push(byId[r.id]);
    }
  });
  return roots;
}

function isNodeDone(node) {
  if (node.children && node.children.length > 0 && node.children_required) {
    return node.children.filter(c => isNodeDone(c)).length >= node.children_required;
  }
  if (node.children && node.children.length > 0 && !node.children_required) {
    // All children must be done
    return node.children.every(c => isNodeDone(c));
  }
  return node.completed == 1;
}

function renderReqNode(node, depth) {
  // Notes: no number, not required, no children ‚Äî render as muted italic text
  const hasKids = node.children && node.children.length > 0;
  const isNote  = !node.requirement_number && node.required == 0 && !hasKids;

  if (isNote) {
    return `<div class="req-note-text">${esc(node.req_name)}</div>`;
  }

  const done     = isNodeDone(node);
  const doneKids = hasKids ? node.children.filter(c => isNodeDone(c)).length : 0;
  const numLabel = node.requirement_number
    ? `<span class="req-num" style="min-width:24px">${esc(node.requirement_number)}</span>`
    : '';

  let childrenHTML = '';
  if (hasKids) {
    const chooseLabel = node.children_required
      ? `<div class="req-choose-label">Complete ${node.children_required} of ${node.children.length} ‚Äî ${doneKids} done</div>`
      : (doneKids > 0 ? `<div class="req-choose-label">${doneKids} of ${node.children.length} done</div>` : '');
    childrenHTML = chooseLabel
      + `<div class="req-children">${node.children.map(c => renderReqNode(c, depth + 1)).join('')}</div>`;
  }

  const dateHTML = done && node.date_completed && !hasKids
    ? `<div class="req-date">‚úì ${fmtDate(node.date_completed)}</div>`
    : '';

  const nodeClass = `req-node ${done ? 'node-done' : 'node-todo'} ${depth > 0 ? 'is-child' : ''}`;
  return `<div class="${nodeClass}">
    <div class="req-node-row">
      <div class="req-circle ${done ? 'done' : 'todo'}">${done ? '‚úì' : ''}</div>
      <div class="req-node-text">
        <div class="req-node-title">${numLabel}<span>${esc(node.req_name)}</span></div>
        ${dateHTML}
      </div>
    </div>
    ${childrenHTML}
  </div>`;
}

// Close modals on Escape key
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') { closeMBModal(); closeTroopMBModal(); closePipelineModal(); }
});

// ‚îÄ‚îÄ‚îÄ Tent Matching ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let tentCrews        = [];   // [{id, name, scouts:[userId], analysisResult}]
let tentScoutMap     = {};   // userId -> {user_id, name, birthdate, age}
let _tentInitialized = false;
let _poolExpanded    = {};   // crewId -> bool (whether pool is explicitly expanded after analysis)
let _poolSort        = 'name'; // 'name' | 'age'
const _TENT_KEY = 'scouting_tents_v1';

function _saveTentState() {
  try {
    localStorage.setItem(_TENT_KEY, JSON.stringify({
      crews: tentCrews.map(({id, name, scouts}) => ({id, name, scouts}))
    }));
  } catch {}
}

function _loadTentState() {
  tentCrews = [];
  try {
    const raw = localStorage.getItem(_TENT_KEY);
    if (!raw) return;
    const saved = JSON.parse(raw);
    const arr = saved.crews || (Array.isArray(saved) ? saved : []);
    tentCrews = arr.map(c => ({
      id: c.id, name: c.name || 'Crew',
      scouts: Array.isArray(c.scouts) ? c.scouts : [],
      analysisResult: null
    }));
  } catch {}
}

function loadTentView() {
  if (!db) {
    const el = document.getElementById('tent-editor');
    if (el) el.innerHTML = '<div class="empty-state"><div class="ei">‚õ∫</div><p>Load a database to use Tent Matching.</p></div>';
    const btn = document.getElementById('tent-analyze-all-btn');
    if (btn) btn.style.display = 'none';
    return;
  }
  if (!_tentInitialized) {
    const rows = q(`SELECT user_id,
      TRIM(COALESCE(first_name,'') || ' ' || COALESCE(last_name,'')) AS name,
      birthdate FROM scouts ORDER BY last_name, first_name`);
    tentScoutMap = {};
    rows.forEach(r => {
      tentScoutMap[String(r.user_id)] = {
        user_id: String(r.user_id),
        name: r.name || String(r.user_id),
        birthdate: r.birthdate || null,
        age: calcAge(r.birthdate)
      };
    });
    _loadTentState();
    tentCrews.forEach(c => { c.scouts = c.scouts.filter(uid => !!tentScoutMap[uid]); });
    _tentInitialized = true;
  }
  _renderAllCrews();
}

function _renderAllCrews() {
  const el = document.getElementById('tent-editor');
  if (!el) return;

  // Show/hide "Analyze All" button
  const analyzeBtn = document.getElementById('tent-analyze-all-btn');
  if (analyzeBtn) analyzeBtn.style.display = tentCrews.some(c => c.scouts.length >= 2) ? '' : 'none';

  if (!tentCrews.length) {
    el.innerHTML = `<div class="empty-state"><div class="ei">‚õ∫</div><p>Create a crew to start assigning Scouts and checking tent arrangements.</p></div>`;
    return;
  }

  // Summary line
  const analyzed     = tentCrews.filter(c => c.analysisResult);
  const validCount   = analyzed.filter(c => c.analysisResult.valid).length;
  const invalidCount = analyzed.filter(c => !c.analysisResult.valid).length;
  const pendingCount = tentCrews.length - analyzed.length;
  const parts = [];
  if (validCount)   parts.push(`<span style="color:var(--green);font-weight:700">${validCount} valid</span>`);
  if (invalidCount) parts.push(`<span style="color:var(--red);font-weight:700">${invalidCount} invalid</span>`);
  if (pendingCount) parts.push(`<span>${pendingCount} not yet analyzed</span>`);
  const summaryHtml = parts.length
    ? `<div class="tent-summary">${tentCrews.length} crew${tentCrews.length !== 1 ? 's' : ''}: ${parts.join(' ¬∑ ')}</div>`
    : '';

  // Capture filter values and pool scroll positions before re-render
  const _filterVals = {};
  const _scrollTops = {};
  document.querySelectorAll('[id^="tent-pool-filter-"]').forEach(input => {
    const crewId = input.id.replace('tent-pool-filter-', '');
    if (input.value) _filterVals[crewId] = input.value;
  });
  document.querySelectorAll('[id^="tent-pool-list-"]').forEach(list => {
    const crewId = list.id.replace('tent-pool-list-', '');
    if (list.scrollTop) _scrollTops[crewId] = list.scrollTop;
  });
  el.innerHTML = summaryHtml + `<div class="tent-crews-grid">${tentCrews.map(crew => _renderCrewCard(crew)).join('')}</div>`;
  // Restore filter values, scroll positions, and re-apply filtering
  Object.entries(_filterVals).forEach(([crewId, val]) => {
    const input = document.getElementById(`tent-pool-filter-${crewId}`);
    if (input) { input.value = val; _filterPool(crewId); }
  });
  Object.entries(_scrollTops).forEach(([crewId, top]) => {
    const list = document.getElementById(`tent-pool-list-${crewId}`);
    if (list) list.scrollTop = top;
  });
}

function _renderCrewCard(crew) {
  const takenElsewhere = new Set(tentCrews.filter(c => c.id !== crew.id).flatMap(c => c.scouts));
  const allScouts = Object.values(tentScoutMap);
  const result = crew.analysisResult;

  const inCrew    = allScouts.filter(s =>  crew.scouts.includes(s.user_id))
                             .sort((a, b) => a.name.localeCompare(b.name));
  const available = allScouts.filter(s => !crew.scouts.includes(s.user_id) && !takenElsewhere.has(s.user_id))
                             .sort((a, b) => _poolSort === 'age'
                               ? (a.age ?? 999) - (b.age ?? 999) || a.name.localeCompare(b.name)
                               : a.name.localeCompare(b.name));
  const takenCount = allScouts.filter(s => takenElsewhere.has(s.user_id)).length;

  // Crew members with remove buttons
  const memberRows = inCrew.length === 0
    ? `<div class="no-data" style="padding:8px 0;font-size:0.8rem">No scouts yet.</div>`
    : inCrew.map(s => {
        const ageHtml = s.age !== null
          ? `<span class="tent-scout-age">Age ${s.age}</span>`
          : `<span class="tent-scout-noage" title="Run sync-scouts to get birthdate">‚ö† no birthdate</span>`;
        return `<div class="tent-scout-row">
          <span class="tent-scout-name">${esc(s.name)}</span>
          ${ageHtml}
          <button class="btn-remove-scout" onclick="tentRemoveScout('${crew.id}','${s.user_id}')" title="Remove">‚úï</button>
        </div>`;
      }).join('');

  // Available scouts pool (excludes in-crew and taken-elsewhere)
  const poolItems = available.map(s => {
    const ageStr = s.age !== null ? `age ${s.age}` : '';
    return `<div class="pool-scout ps-avail" data-name="${s.name.toLowerCase()}" onclick="tentAddScout('${crew.id}','${s.user_id}')">
      <span class="pool-scout-icon">+</span>
      <span class="pool-scout-name">${esc(s.name)}</span>
      ${ageStr ? `<span class="pool-scout-age">${esc(ageStr)}</span>` : ''}
    </div>`;
  }).join('');

  const takenNote = takenCount > 0
    ? `<div class="pool-other-note">${takenCount} scout${takenCount !== 1 ? 's' : ''} assigned to other crews</div>`
    : '';
  const emptyNote = allScouts.length === 0
    ? `<div style="padding:12px 10px;font-size:0.8rem;color:var(--muted);text-align:center">No scouts in database</div>`
    : available.length === 0 && takenCount === 0
      ? `<div style="padding:12px 10px;font-size:0.8rem;color:var(--muted);text-align:center">All scouts assigned</div>`
      : '';

  let resultHtml = '';
  if (result) {
    if (result.valid) {
      const groupsHtml = result.assignment.map(tent => {
        const ages = tent.map(s => s.age).filter(a => a !== null);
        const lo = Math.min(...ages), hi = Math.max(...ages);
        const ageRange = ages.length ? (lo === hi ? `Age ${lo}` : `Ages ${lo}‚Äì${hi}`) : '';
        return `<div class="tent-group">
          <div class="tent-group-label">${tent.length}-person<br>tent</div>
          <div class="tent-group-scouts">${tent.map(s => `<span class="tent-group-scout">${esc(s.name)}${s.age !== null ? ` (${s.age})` : ''}</span>`).join('')}</div>
          ${ageRange ? `<div class="tent-group-age-range">${esc(ageRange)}</div>` : ''}
        </div>`;
      }).join('');
      resultHtml = `<div class="tent-results">
        <div class="tent-result-banner valid">‚úì Valid tenting arrangement</div>
        <div class="tent-group-list">${groupsHtml}</div>
      </div>`;
    } else {
      let partialHtml = '';
      if (result.compatibleGroups && result.compatibleGroups.length) {
        const compatGroupsHtml = result.compatibleGroups.map(tent => {
          const ages = tent.map(s => s.age).filter(a => a !== null);
          const lo = Math.min(...ages), hi = Math.max(...ages);
          const ageRange = ages.length ? (lo === hi ? `Age ${lo}` : `Ages ${lo}‚Äì${hi}`) : '';
          return `<div class="tent-group">
            <div class="tent-group-label">${tent.length}-person<br>tent</div>
            <div class="tent-group-scouts">${tent.map(s => `<span class="tent-group-scout">${esc(s.name)}${s.age !== null ? ` (${s.age})` : ''}</span>`).join('')}</div>
            ${ageRange ? `<div class="tent-group-age-range">${esc(ageRange)}</div>` : ''}
          </div>`;
        }).join('');
        partialHtml += `<div class="tent-partial-section">
          <div class="tent-partial-label">Compatible groups:</div>
          <div class="tent-group-list">${compatGroupsHtml}</div>
        </div>`;
      }
      if (result.incompatible && result.incompatible.length) {
        const badHtml = result.incompatible
          .map(s => `<span class="tent-incompatible-scout">${esc(s.name)}${s.age !== null ? ` (${s.age})` : ''}</span>`)
          .join('');
        partialHtml += `<div class="tent-partial-section">
          <div class="tent-partial-label">Can't be accommodated:</div>
          <div class="tent-incompatible-list">${badHtml}</div>
        </div>`;
      }
      resultHtml = `<div class="tent-results">
        <div class="tent-result-banner invalid">‚úó Cannot be tented</div>
        ${partialHtml}
      </div>`;
    }
  }

  const canAnalyze = inCrew.length >= 2;
  const poolOpen = result ? (_poolExpanded[crew.id] || false) : true;
  return `<div class="tent-crew-card panel">
    <div class="panel-header">
      <span class="panel-icon">‚õ∫</span>
      <input class="tent-crew-name-input" id="tent-name-${crew.id}" value="${esc(crew.name)}"
        onchange="tentRenameCrew('${crew.id}',this.value)" placeholder="Crew name">
      <button class="btn-tent btn-tent-danger" style="flex-shrink:0;padding:5px 10px;font-size:0.78rem"
        onclick="tentDeleteCrew('${crew.id}')" title="Delete crew">‚úï</button>
    </div>
    <div class="panel-body">
      <div class="tent-scouts-list" style="margin-bottom:12px">${memberRows}</div>
      <details class="tent-pool-details" ${poolOpen ? 'open' : ''} ontoggle="_onPoolToggle('${crew.id}',this.open)">
        <summary class="tent-pool-summary">Add scouts</summary>
        <div class="tent-scout-pool">
          <div class="pool-sort-bar">
            <span class="pool-sort-label">Sort:</span>
            <button class="pool-sort-btn${_poolSort === 'name' ? ' active' : ''}" onclick="_setPoolSort('name')">Name</button>
            <button class="pool-sort-btn${_poolSort === 'age'  ? ' active' : ''}" onclick="_setPoolSort('age')">Age</button>
          </div>
          <input type="text" class="tent-pool-filter" id="tent-pool-filter-${crew.id}"
            placeholder="Filter scouts‚Ä¶" oninput="_filterPool('${crew.id}')">
          <div class="tent-pool-list" id="tent-pool-list-${crew.id}">
            ${emptyNote}${poolItems}${takenNote}
          </div>
        </div>
      </details>
      <div class="tent-actions">
        <button class="btn-tent btn-tent-primary" onclick="tentAnalyze('${crew.id}')"
          ${canAnalyze ? '' : 'disabled title="Need at least 2 Scouts"'}>Analyze</button>
        ${result ? `<button class="btn-tent btn-tent-secondary" onclick="tentClearAnalysis('${crew.id}')">Clear</button>` : ''}
      </div>
      ${resultHtml}
    </div>
  </div>`;
}

// Tent scout pool filter (hides/shows pool rows in place ‚Äî no re-render needed)
function _filterPool(crewId) {
  const input = document.getElementById(`tent-pool-filter-${crewId}`);
  const list  = document.getElementById(`tent-pool-list-${crewId}`);
  if (!input || !list) return;
  const val = input.value.trim().toLowerCase();
  list.querySelectorAll('.pool-scout').forEach(el => {
    const name = el.dataset.name || '';
    el.style.display = !val || name.includes(val) ? '' : 'none';
  });
}

function _onPoolToggle(crewId, isOpen) {
  _poolExpanded[crewId] = isOpen;
}

function _setPoolSort(by) {
  _poolSort = by;
  _renderAllCrews();
}

// Crew / scout CRUD
function addTentCrew() {
  if (!db) return;
  const id = 'crew_' + Date.now();
  tentCrews.push({id, name: `Crew ${tentCrews.length + 1}`, scouts: [], analysisResult: null});
  _saveTentState();
  _renderAllCrews();
  setTimeout(() => { const n = document.getElementById(`tent-name-${id}`); if (n) { n.focus(); n.select(); } }, 40);
}

function tentRenameCrew(id, name) {
  const crew = tentCrews.find(c => c.id === id);
  if (!crew) return;
  crew.name = name;
  _saveTentState();
  _renderAllCrews();
}

function tentDeleteCrew(id) {
  tentCrews = tentCrews.filter(c => c.id !== id);
  _saveTentState();
  _renderAllCrews();
}

function tentAddScout(crewId, userId) {
  const crew = tentCrews.find(c => c.id === crewId);
  if (!crew || crew.scouts.includes(userId)) return;
  crew.scouts.push(userId);
  crew.analysisResult = null;
  _saveTentState();
  _renderAllCrews();
}

function tentRemoveScout(crewId, userId) {
  const crew = tentCrews.find(c => c.id === crewId);
  if (!crew) return;
  crew.scouts = crew.scouts.filter(u => u !== userId);
  crew.analysisResult = null;
  _saveTentState();
  _renderAllCrews();
}

function tentClearAnalysis(crewId) {
  const crew = tentCrews.find(c => c.id === crewId);
  if (crew) crew.analysisResult = null;
  _renderAllCrews();
}

// ‚îÄ‚îÄ‚îÄ Tenting algorithm (DP) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// A valid arrangement partitions scouts into tents of 2 or 3 where every
// tentmate is within 2 years of age of each other.
// Sorting by age first means only consecutive scouts need to be grouped,
// so a linear DP works: dp[i] = scouts[0..i-1] can be validly tented.
function _runTentAnalysis(scouts) {
  if (scouts.length < 2) {
    return {valid: false, reason: scouts.length === 0
      ? 'No Scouts in this crew.'
      : 'Only 1 Scout ‚Äî Scouts cannot tent alone.'};
  }
  const noAge = scouts.filter(s => s.age === null);
  if (noAge.length) {
    return {valid: false, reason: `Missing birthdate for: ${noAge.map(s => s.name).join(', ')}. Run sync-scouts to pull birthdate data.`};
  }
  const sorted = [...scouts].sort((a, b) => a.age - b.age);
  const n  = sorted.length;
  const dp = new Array(n + 1).fill(false);
  dp[0] = true;
  for (let i = 1; i <= n; i++) {
    if (i >= 2 && dp[i-2] && sorted[i-1].age - sorted[i-2].age <= 2) dp[i] = true;
    if (i >= 3 && dp[i-3] && sorted[i-1].age - sorted[i-3].age <= 2) dp[i] = true;
  }
  if (!dp[n]) {
    const {compatibleGroups, incompatible, reason} = _partialTentAssignment(sorted);
    return {valid: false, reason, compatibleGroups, incompatible};
  }
  // Reconstruct one valid assignment (greedy from the end, prefer 3-person tents)
  const assignment = [];
  let i = n;
  while (i > 0) {
    if (i >= 3 && dp[i-3] && sorted[i-1].age - sorted[i-3].age <= 2) {
      assignment.unshift(sorted.slice(i-3, i)); i -= 3;
    } else {
      assignment.unshift(sorted.slice(i-2, i)); i -= 2;
    }
  }
  return {valid: true, assignment};
}

// When the full crew can't be tented, find the maximum number of scouts that
// CAN be validly grouped, and report the rest as incompatible.
// Uses a "skip" DP: f[i] = max scouts tentable from sorted[i..n-1], allowing
// individual scouts to be skipped (marked incompatible).
function _partialTentAssignment(sorted) {
  const n = sorted.length;
  const f = new Array(n + 2).fill(0);
  for (let i = n - 1; i >= 0; i--) {
    f[i] = f[i + 1]; // option: skip scout i
    if (i + 1 < n && sorted[i+1].age - sorted[i].age <= 2)
      f[i] = Math.max(f[i], 2 + f[i + 2]);
    if (i + 2 < n && sorted[i+2].age - sorted[i].age <= 2)
      f[i] = Math.max(f[i], 3 + f[i + 3]);
  }
  // Reconstruct: prefer 3-person > 2-person > skip
  const compatibleGroups = [];
  const incompatibleIds  = new Set();
  let i = 0;
  while (i < n) {
    if (i + 2 < n && sorted[i+2].age - sorted[i].age <= 2 && 3 + f[i+3] === f[i]) {
      compatibleGroups.push(sorted.slice(i, i + 3)); i += 3;
    } else if (i + 1 < n && sorted[i+1].age - sorted[i].age <= 2 && 2 + f[i+2] === f[i]) {
      compatibleGroups.push(sorted.slice(i, i + 2)); i += 2;
    } else {
      incompatibleIds.add(sorted[i].user_id); i += 1;
    }
  }
  const incompatible = sorted.filter(s => incompatibleIds.has(s.user_id));
  // Build a human-readable reason
  let reason;
  if (incompatible.length === n) {
    reason = "No valid tent pairings exist among these Scouts.";
  } else {
    const loners = incompatible.filter(
      s => !sorted.some(o => o !== s && Math.abs(o.age - s.age) <= 2)
    );
    const structural = incompatible.filter(s => !loners.includes(s));
    const parts = [];
    if (loners.length)
      parts.push(`No compatible partner for: ${loners.map(s => `${s.name} (${s.age})`).join(', ')}.`);
    if (structural.length)
      parts.push(`Age distribution prevents valid tent splits for: ${structural.map(s => `${s.name} (${s.age})`).join(', ')}.`);
    reason = parts.join(' ');
  }
  return {compatibleGroups, incompatible, reason};
}

function tentAnalyze(crewId) {
  const crew = tentCrews.find(c => c.id === crewId);
  if (!crew) return;
  crew.analysisResult = _runTentAnalysis(crew.scouts.map(uid => tentScoutMap[uid]).filter(Boolean));
  _poolExpanded[crewId] = false;
  _saveTentState();
  _renderAllCrews();
}

function tentAnalyzeAll() {
  tentCrews.forEach(crew => {
    if (crew.scouts.length >= 2) {
      crew.analysisResult = _runTentAnalysis(crew.scouts.map(uid => tentScoutMap[uid]).filter(Boolean));
      _poolExpanded[crew.id] = false;
    }
  });
  _saveTentState();
  _renderAllCrews();
}

// ‚îÄ‚îÄ‚îÄ Utilities ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function esc(str) {
  if (str == null) return '';
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;');
}

const MONTHS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

function calcAge(dateStr) {
  if (!dateStr) return null;
  const dob = new Date(dateStr.split('T')[0] + 'T00:00:00');
  if (isNaN(dob)) return null;
  const today = new Date();
  let age = today.getFullYear() - dob.getFullYear();
  const m = today.getMonth() - dob.getMonth();
  if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) age--;
  return age;
}

function fmtDate(s) {
  if (!s) return '‚Äî';
  const d = s.split('T')[0];
  const parts = d.split('-');
  if (parts.length !== 3) return s;
  const [y, m, day] = parts;
  const mi = parseInt(m, 10) - 1;
  if (mi < 0 || mi > 11) return s;
  return `${MONTHS[mi]} ${parseInt(day, 10)}, ${y}`;
}

function fmtDt(s) {
  if (!s) return '‚Äî';
  try {
    const d = new Date(s);
    if (isNaN(d)) return s;
    return d.toLocaleDateString('en-US', {year:'numeric', month:'short', day:'numeric'});
  } catch { return s; }
}
</script>
</body>
</html>
